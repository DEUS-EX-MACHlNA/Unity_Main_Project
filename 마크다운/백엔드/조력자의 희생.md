# 조력자의 희생 엔딩 — 단계 요약

**전제:** 이 문서는 조력자의 희생 엔딩에 이르는 **주요 단계**만 정리한다. 요청/응답 JSON 구조·필드 의미·NPC·아이템 매핑은 상위 문서를 참조할 것.

---

## 흐름 개요

| 단계       | 내용                                                                                                                                                                                                                                                                                         |
| ---------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **조건 1** | 바론(개)을 잘 돌봄 → 바론 호감도 최대 시 마당에서 액자를 건네줌 → 액자는 동생의 인간성 수치를 높일 수 있음                                                                                                                                                                                   |
| **조건 2** | 액자를 동생에게 보여 줌 → 동생이 인간 시절 기억 회복·희생 결심 → 탈출 정보 전달(자기 방 장롱에 숨었다가 나오기, 거실 비밀 열쇠·개구멍 자물쇠) → 밤의 대화에서 동생이 주인공 탈출 거짓말·내일 찾자 제안 → 다음 날 가족 밖으로 나감 → 주인공이 거실에서 열쇠 획득 후 개구멍 자물쇠를 열고 탈출 |

---

## 조건 1 — 아이템 습득 (바론 호감도·액자)

1. **바론을 잘 돌봐 주기**
   - 바론(`dog`/`baron`) 대상으로 돌보기·산책·먹이 주기 등 행동 시 `npc_stats.dog.trust`(절대값) 상승.

   **예시 프론트 입력**

   ```json
   {
     "chat_input": "바론에게 다가가 살짝 쓰다듬어 준다.",
     "npc_name": "baron",
     "item_name": ""
   }
   ```

   **예시 백엔드 응답**

   ```json
   {
     "narrative": "바론이 꼬리를 흔들며 다가온다. 따뜻한 눈으로 나를 올려다본다.",
     "ending_info": null,
     "state_result": {
       "npc_stats": { "dog": { "trust": 25, "suspicion": 0, "fear": 0 } }
     }
   }
   ```

2. **바론 호감도 최대 시 마당에서 액자를 건네주기**
   - 바론 호감도가 최대치가 되면, 마당에서 (진짜 가족이 담긴) 액자를 꺼내 주인공에게 건넴.
   - `inventory_add`: `real_family_photo`. 이 액자는 동생에게 보여 주면 동생의 인간성 수치를 높이는 데 쓰인다.

   **예시 프론트 입력**

   ```json
   {
     "chat_input": "마당에서 바론과 놀아 준다.",
     "npc_name": "baron",
     "item_name": ""
   }
   ```

   **예시 백엔드 응답**

   ```json
   {
     "narrative": "바론이 마당 한편에서 낡은 액자를 물어 와 내 앞에 내려놓는다. 안에는 예전 가족의 사진이 담겨 있다. 동생에게 보여 주면 그때의 기억이 조금이라도 돌아올지도 모른다.",
     "ending_info": null,
     "state_result": { "inventory_add": ["real_family_photo"] }
   }
   ```

---

## 조건 2 — 동생의 희생 & 탈출 정보 습득

1. **액자를 동생에게 보여 주기**
   - 동생에게 액자(`real_family_photo`)를 보여 주면, 동생이 인간 시절 기억을 되찾지만 다시는 인간으로 돌아갈 수 없음을 깨닫고, 자신이 가족을 밖으로 유인하니 동생 방(장롱)에 숨어 있다가 나오라고 함. 거실에 비밀 열쇠가 있으니 찾아서 개구멍 자물쇠를 열고 탈출하라고 **나레이션**으로 전달.
   - **플래그:** `state_result.flags.sibling_escape_plan_agreed: true` 를 반드시 설정. 액자 보여 준 뒤 설정. 다음 Day에 새엄마·새아빠·동생 비활성화용.
   - 동생에게 보여 주면 액자가 소모됨. `inventory_remove`: `real_family_photo`.

   **예시 프론트 입력**

   ```json
   {
     "chat_input": "동생에게 액자를 보여 준다.",
     "npc_name": "sibling",
     "item_name": "real_family_photo"
   }
   ```

   **예시 백엔드 응답**

   ```json
   {
     "narrative": "동생이 액자를 바라보더니 눈에 눈물이 맺힌다. '...이거, 우리 가족이지.' 잠시 침묵이 흐른 뒤 동생이 말한다. '나는 이제 다시는 인간으로 돌아갈 수 없어. 대신 너는 나가야 해.' 동생은 가족들을 밖으로 유인할 테니, 자신의 방 장롱에 숨어 있다가 나오라고 한다. 그리고 거실 어딘가에 비밀 열쇠가 있으니 그걸 찾아 네 방 개구멍의 자물쇠를 열고 탈출하라고 속삭인다.",
     "ending_info": null,
     "state_result": {
       "npc_stats": { "sibling": { "trust": 80, "suspicion": 0, "fear": 0 } },
       "inventory_remove": ["real_family_photo"],
       "flags": { "sibling_escape_plan_agreed": true }
     }
   }
   ```

2. **밤의 대화 — 동생이 주인공 탈출 거짓말·내일 찾자 제안**
   - 턴이 0이 되면 프론트가 `POST /api/v1/game/{gameId}/night_dialogue` 호출.
   - 백엔드는 **조력자의 희생** 루트가 진행 중임을 반영해, 동생이 “주인공이 이미 밖으로 탈출했다”고 거짓말하고, 가족에게 내일 찾아 보자고 제안하는 **Night 대화 응답**을 반환.
   - `sibling_escape_plan_agreed` 가 true인 상태에서 이 대화가 재생됨. 백엔드는 `state_result.npc_disabled_states` 로 새엄마·새아빠·동생을 **10턴 동안** 비활성화(`is_disabled: true`, `remaining_turns: 10`, `reason`: "밖에서 수색 중") 전달. 프론트는 이 플래그가 true이면 **다음 Day**에 해당 NPC들을 비활성화(비표시) 처리한다.

   **예시 백엔드 응답** (Night 대화)

   ```json
   {
     "narrative": "가족이 거실에 모여 이야기를 나눈다.",
     "dialogues": [
       {
         "speaker_name": "엘리노어 (새엄마)",
         "dialogue": "그 아이는 어디로 갔을까. 오늘부터 눈에 띄지 않네."
       },
       {
         "speaker_name": "루카스 (동생)",
         "dialogue": "나, 오늘 밖에서 봤어. 이미 달아난 것 같아. 멀리 안 갔을 테니까 내일 같이 찾아보자."
       },
       {
         "speaker_name": "아더 (새아빠)",
         "dialogue": "그렇다면 내일 아침에 나가서 주변을 수색해 보자."
       }
     ],
     "ending_info": null,
     "state_result": {
       "npc_stats": {
         "new_mother": { "trust": 50, "suspicion": 0, "fear": 0 },
         "new_father": { "trust": 50, "suspicion": 0, "fear": 0 },
         "sibling": { "trust": 80, "suspicion": 0, "fear": 0 }
       },
       "npc_disabled_states": {
         "new_mother": {
           "is_disabled": true,
           "remaining_turns": 10,
           "reason": "밖에서 수색 중"
         },
         "new_father": {
           "is_disabled": true,
           "remaining_turns": 10,
           "reason": "밖에서 수색 중"
         },
         "sibling": {
           "is_disabled": true,
           "remaining_turns": 10,
           "reason": "밖에서 수색 중"
         }
       }
     },
     "debug": {
       "reasoning": "조력자의 희생 루트: 동생이 주인공 탈출 거짓말, 내일 찾자 제안. 다음 날 가족 수색 나감.",
       "turn_after": 0
     }
   }
   ```

3. **다음 날 가족이 밖으로 나감**
   - `sibling_escape_plan_agreed` 가 true이면 **다음 Day 시작 시** 프론트는 새엄마·새아빠·동생을 비활성화(비표시) 처리한다.
   - 해당 Day 동안 주인공은 빈 집에서 거실 액자 탐색 → 비밀 열쇠 획득 → 개구멍 탈출을 진행할 수 있다.

4. **거실에서 비밀 열쇠 획득**
   - 가족이 밖에 있는 동안 주인공이 거실에서 비밀 열쇠를 획득. `inventory_add`: `secret_key`(또는 `brass_key`, NameMapper에서 동일 타입 매핑).

   **예시 프론트 입력**

   ```json
   {
     "chat_input": "거실에서 액자를 탐색해 비밀 열쇠를 찾는다.",
     "npc_name": "",
     "item_name": "livingroom_photo"
   }
   ```

   **예시 백엔드 응답**

   ```json
   {
     "narrative": "거실에 아무도 없다. 액자 안에서 낡은 비밀 열쇠를 찾았다. 개구멍의 자물쇠와 맞을 것 같다.",
     "ending_info": null,
     "state_result": { "inventory_add": ["secret_key"] }
   }
   ```

5. **개구멍 자물쇠를 열고 탈출 → 엔딩**
   - 조건: 비밀 열쇠 보유, 동생 탈출 계획 합의 후·가족 밖에 나간 상태.
   - 개구멍(`hole`)에 열쇠(`secret_key`)를 사용하면 **엔딩 트리거**.
   - 응답에 **`ending_info`**: `ending_id: "siblings_help"`, `name`, `epilogue_prompt` 설정.
   - `inventory_remove`: 열쇠.

   **예시 프론트 입력**

   ```json
   {
     "chat_input": "개구멍의 자물쇠에 열쇠를 꽂아 연다.",
     "npc_name": "",
     "item_name": ["hole", "secret_key"]
   }
   ```

   - `item_name`: 상호작용 대상(`hole`)과 사용 아이템(`secret_key`) 모두 전달.

   **예시 백엔드 응답**

   ```json
   {
     "narrative": "동생이 가족을 밖으로 유인해 준 덕분에, 조용히 자물쇠에 열쇠를 꽂았다. 찰칵— 개구멍이 열리고, 밖으로 나갈 수 있다. 동생의 희생 위에 서 있는 것만 같다.",
     "ending_info": {
       "ending_id": "siblings_help",
       "name": "조력자의 희생 (Sibling's Help)",
       "epilogue_prompt": "동생이 가족을 유인하는 사이, 비밀 열쇠로 개구멍을 열고 탈출했다. 동생은 다시는 만날 수 없을 것이다."
     },
     "state_result": { "inventory_remove": ["secret_key"] }
   }
   ```

---

## 참고 ID (요약)

- **NPC:** `baron`/`dog` → `NPCType.Dog`, `sibling`/`brother` → `NPCType.Sibling` (BackendResponseSpec.md NPC 매핑 참조).
- **아이템:** `real_family_photo`(진짜 가족 사진 액자, 동생 인간성 관련), `secret_key`/`brass_key`(비밀 열쇠). NameMapper에서 `secret_key` → `ItemType.BrassKey`.
- **플래그:** `sibling_escape_plan_agreed` — 액자 보여 준 뒤 설정. 다음 Day에 새엄마·새아빠·동생 비활성화용.
- **엔딩:** `siblings_help` → `EndingType.SiblingsHelp`.
