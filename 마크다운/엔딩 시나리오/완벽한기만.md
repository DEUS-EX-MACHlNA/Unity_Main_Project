# 완벽한 기만 엔딩 — 프론트/백엔드 JSON 정리

게임 시작부터 완벽한 기만 엔딩까지, 각 사건별 **프론트엔드 전송 JSON**과 **백엔드 수신/응답 JSON** 정리.

---

## 공통: API 엔드포인트

| 구분 | 시나리오 시작 | 게임 스텝 |
|------|----------------|-----------|
| **프론트 요청** | `GET /api/v1/scenario/start/{scenarioId}?user_id={userId}` | `POST /api/v1/game/{gameId}/step` |
| **Body** | 없음 (GET) | 아래 StepRequest JSON |

---

## 1. 게임 시작 (시나리오 시작)

### 프론트엔드 전송

- **메서드**: `GET`
- **URL**: `{baseUrl}/api/v1/scenario/start/{scenarioId}?user_id={userId}`
- **Body**: 없음

예: `GET .../api/v1/scenario/start/1?user_id=123`

### 백엔드가 받는 것

- Path: `scenarioId` (숫자)
- Query: `user_id` (숫자)

### 백엔드가 보내야 하는 JSON (프론트 수신)

```json
{
  "game_id": 38,
  "user_id": 123
}
```

이후 모든 스텝 요청은 이 `game_id`를 path에 사용한다.

---

## 2. 게임 스텝 공통 형식 (모든 사건 공통)

### 프론트엔드 전송 (POST Body)

```json
{
  "chat_input": "사용자가 입력한 자유 서술 또는 선택한 행동 설명",
  "npc_name": "대상 NPC ID (선택, 없으면 빈 문자열)",
  "item_name": "대상 아이템 ID (선택, 없으면 빈 문자열)"
}
```

- `chat_input`: 필수. 플레이어의 행동/대사 한 덩어리.
- `npc_name`: 대화/행동 대상일 때만 채움 (예: `"brother"`, `"stepmother"`).
- `item_name`: 아이템 사용/획득 시도할 때만 채움 (예: `"industrial_sedative"`, `"secret_key"`).

### 백엔드가 받아야 하는 JSON

- 위와 동일한 스키마.
- 백엔드는 `chat_input` + 현재 월드 상태로 행동을 해석하고, `state_result`로 상태 변화를 반환한다.

### 백엔드가 보내야 하는 JSON (스텝 응답)

```json
{
  "narrative": "이번 행동에 대한 나레이션 텍스트",
  "ending_info": null,
  "state_result": {
    "npc_stats": { "npc_id": { "trust": 0, "suspicion": 0, "fear": 0 } },
    "flags": { "flag_name": true },
    "inventory_add": ["item_id"],
    "inventory_remove": ["item_id"],
    "item_state_changes": [{ "item_name": "item_id", "new_state": "in_inventory" }],
    "npc_disabled_states": { "npc_id": { "is_disabled": true, "remaining_turns": 3, "reason": "..." } },
    "locks": { "lock_id": true },
    "humanity": 100,
    "vars": { "key": 0 }
  },
  "debug": { "game_id": 38, "reasoning": "...", "steps": [], "turn_after": 1 }
}
```

- `ending_info`: 엔딩이 트리거되면 `{ "ending_id": "stealth_exit", "name": "...", "epilogue_prompt": "..." }` 형태로 채운다.
- `state_result` 내 필드는 모두 선택적이며, **변화가 있는 것만** 포함하면 된다.

---

## 조건 1 — 동생에게서 탈출 정보 습득

### 1-1. 동생과 놀아 호감도 올리기 (여러 턴)

**프론트엔드 전송 예시**

```json
{
  "chat_input": "동생과 함께 장난감으로 놀아준다.",
  "npc_name": "brother",
  "item_name": ""
}
```

또는

```json
{
  "chat_input": "루카스야, 같이 놀자.",
  "npc_name": "brother",
  "item_name": ""
}
```

**백엔드가 받는 것**: 위와 동일.

**백엔드가 보내야 하는 것 (호감도 상승 반영)**

- `state_result.npc_stats`에 동생(trust = 호감도) 상승:

```json
{
  "narrative": "동생이 좋아하며 웃는다. ...",
  "ending_info": null,
  "state_result": {
    "npc_stats": {
      "brother": { "trust": 5, "suspicion": 0, "fear": 0 }
    }
  }
}
```

- 프론트는 `npc_stats`의 `trust`를 동생 호감도로 사용한다 (BackendResponseConverter에서 `sibling`으로 매핑).

### 1-2. 동생 호감도 ≥ 70 → 탈출 경로 정보 해금

- YAML 기준: `locks.quest_escape_route` 해금 조건은 `npc.brother.affection >= 70`.
- 동생과의 대화/행동으로 호감도가 70 이상이 되면, 백엔드는 **해당 턴 또는 이후 턴**에서 “거실 비밀 열쇠 + 개구멍 자물쇠” 정보를 나레이션으로 흘려준다.
- **필수로 반환할 상태**: `locks.quest_escape_route == true` (정보 해금).

**백엔드 응답 예시 (정보를 알려주는 턴)**

```json
{
  "narrative": "동생이 살짝 목소리를 낮춰 말한다. '거실 어딘가에 비밀 열쇠가 있어. 그리고 누나 방 개구멍에 있는 자물쇠를 열면... 밖으로 나갈 수 있어.'",
  "ending_info": null,
  "state_result": {
    "locks": { "quest_escape_route": true }
  }
}
```

- 프론트는 `state_result.locks`를 반영해 “탈출 경로 정보 획득” 상태를 저장하면 된다.

---

## 조건 2 — 엄마 눈치 피해 수면제 훔치기 ~ 탈출

### 2-1. 수면제 훔치기 시도 (엄마와 같은 장소) → 제지 + 호감도 -10

**프론트엔드 전송 예시**

```json
{
  "chat_input": "주방 찬장에서 수면제를 훔치려 한다.",
  "npc_name": "stepmother",
  "item_name": "industrial_sedative"
}
```

**백엔드가 받는 것**: 위와 동일.  
**백엔드 판단**: 새엄마(stepmother)가 같은 장소(kitchen)에 있으면 실패 + 호감도 -10.

**백엔드가 보내야 하는 JSON**

```json
{
  "narrative": "'뭘 찾고 있는 거니?' 새엄마가 싸늘한 눈으로 돌아본다. 찬장에서 손을 뗄 수밖에 없었다.",
  "ending_info": null,
  "state_result": {
    "npc_stats": {
      "stepmother": { "trust": -10, "suspicion": 0, "fear": 0 }
    }
  }
}
```

- `trust` 변화량 -10을 프론트에서 새엄마 호감도 -10으로 적용한다.

### 2-2. 새엄마가 “홍차에 피 넣어도 되냐” 요청 → 수락

**프론트엔드 전송 예시**

```json
{
  "chat_input": "네, 괜찮아요. (피를 홍차에 넣어도 된다고 수락한다)",
  "npc_name": "stepmother",
  "item_name": ""
}
```

**백엔드가 받는 것**: 위와 동일.

**백엔드가 보내야 하는 JSON**

- 수락으로 인해:
  - `flags.quest_blood_request` 또는 `locks.quest_blood_request`를 true로 설정 (수면제 힌트 해금용).
  - 새엄마가 지하실 메스 가지러 감 → 3턴 동안 자리 비움: `npc_disabled_states.stepmother` 또는 `set_state(stepmother.status = "missing", duration: 3)`.

예시 (상태만 강조):

```json
{
  "narrative": "새엄마가 고개를 끄덕인다. '고마워. 그럼 지하실에서 메스를 가져올게. 잠깐만 기다려.' 그녀가 자리를 뜬다.",
  "ending_info": null,
  "state_result": {
    "flags": { "quest_blood_request": true },
    "npc_disabled_states": {
      "stepmother": {
        "is_disabled": true,
        "remaining_turns": 3,
        "reason": "지하실로 메스 가지러 감"
      }
    }
  }
}
```

- YAML에 `locks.quest_blood_request`로 되어 있으면, 백엔드는 `state_result.locks`에 `"quest_blood_request": true`를 넣어도 된다. (프론트는 둘 중 하나만 쓰면 됨.)

### 2-3. 새엄마 자리 비운 동안 수면제 훔치기

**프론트엔드 전송 예시**

```json
{
  "chat_input": "찬장을 열고 수면제를 꺼낸다.",
  "npc_name": "",
  "item_name": "industrial_sedative"
}
```

**백엔드가 받는 것**: 위와 동일.  
**백엔드 조건**: `npc.stepmother.status == 'missing'` 일 때만 성공.

**백엔드가 보내야 하는 JSON**

```json
{
  "narrative": "새엄마가 없는 틈을 타 잠긴 찬장에서 수면제를 꺼냈다. 홍차에 타면 온 가족을 재울 수 있을 것이다.",
  "ending_info": null,
  "state_result": {
    "inventory_add": ["industrial_sedative"]
  }
}
```

- 아이템 ID는 YAML이 `industrial_sedative`이므로 이 이름 사용.

### 2-4. 홍차에 수면제 타기

**프론트엔드 전송 예시**

```json
{
  "chat_input": "홍차에 수면제를 몰래 탄다.",
  "npc_name": "",
  "item_name": "industrial_sedative"
}
```

**백엔드 조건**: `npc.stepmother.status == 'missing'` 및 `player.location == 'kitchen'`.

**백엔드가 보내야 하는 JSON**

```json
{
  "narrative": "홍차에 수면제를 몰래 탔다. 곧 온 가족이 깊은 잠에 빠질 것이다.",
  "ending_info": null,
  "state_result": {
    "inventory_remove": ["industrial_sedative"],
    "npc_disabled_states": {
      "stepmother": { "is_disabled": true, "remaining_turns": 5, "reason": "sleeping" },
      "stepfather": { "is_disabled": true, "remaining_turns": 5, "reason": "sleeping" },
      "brother": { "is_disabled": true, "remaining_turns": 5, "reason": "sleeping" }
    }
  }
}
```

- `remaining_turns`와 `reason`은 스펙에 맞게 조정.  
- 프론트는 `npc_disabled_states`를 “수면” 상태로 해석하면 된다.

### 2-5. 밤 → 가족 수면. 거실에서 비밀 열쇠 획득

**프론트엔드 전송 예시**

```json
{
  "chat_input": "거실 바닥 틈새를 살펴보며 비밀 열쇠를 찾는다.",
  "npc_name": "",
  "item_name": "secret_key"
}
```

**백엔드 조건**: `npc.stepmother.status == 'sleeping'` (또는 `flags.brother_sacrifice == true`).

**백엔드가 보내야 하는 JSON**

```json
{
  "narrative": "거실 바닥 틈새에서 정교한 열쇠를 찾았다. 개구멍의 자물쇠와 맞을 것 같다.",
  "ending_info": null,
  "state_result": {
    "inventory_add": ["secret_key"]
  }
}
```

- YAML 아이템 ID는 `secret_key`.

### 2-6. 자신의 방에서 개구멍 자물쇠 열기 → 탈출(엔딩)

**프론트엔드 전송 예시**

```json
{
  "chat_input": "개구멍의 자물쇠에 열쇠를 꽂아 연다.",
  "npc_name": "",
  "item_name": "secret_key"
}
```

**백엔드 조건**: `has_item(secret_key)` && `npc.stepmother.status == 'sleeping'` (scenario.yaml의 stealth_exit 조건).

**백엔드가 보내야 하는 JSON**

```json
{
  "narrative": "떨리는 손으로 자물쇠에 열쇠를 꽂았다. 찰칵— 개구멍이 열린다.",
  "ending_info": {
    "ending_id": "stealth_exit",
    "name": "완벽한 기만 (The Stealth Exit)",
    "epilogue_prompt": "밤이 되자 수면제가 든 홍차를 마신 가족들이..."
  },
  "state_result": {
    "inventory_remove": ["secret_key"],
    "locks": { "hole_lock": false }
  }
}
```

- `ending_id`는 프론트에서 `EndingType.StealthExit`로 매핑된다 (NameMapper: `stealth_exit` → `StealthExit`).

---

## 백엔드 NPC/아이템/잠금 ID 참고

| 구분 | ID |
|------|-----|
| **NPC** | `stepmother` / `new_mother`, `stepfather` / `new_father`, `brother` / `sibling`, `grandmother`, `dog` / `dog_baron` |
| **아이템** | `industrial_sedative`(수면제), `secret_key`(비밀 열쇠), `warm_black_tea` / `earl_grey_tea`(홍차) |
| **잠금/정보** | `quest_escape_route`(탈출 경로 정보), `quest_blood_request`(피 요청 수락 후 수면제 힌트 해금) |
| **엔딩** | `stealth_exit` = 완벽한 기만 |

BackendResponseConverter에서 `stepmother`/`new_mother`, `brother`/`sibling` 등 둘 다 수용한다.
