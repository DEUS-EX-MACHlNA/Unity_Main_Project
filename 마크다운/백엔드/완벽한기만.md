# 완벽한 기만 엔딩 — 단계 요약

**전제:** 이 문서는 완벽한 기만 엔딩에 이르는 **주요 단계**만 정리한다. 요청/응답 JSON 구조·필드 의미·NPC·아이템 매핑은 상위 문서를 참조할 것.

---

## 흐름 개요

| 단계       | 내용                                                                                           |
| ---------- | ---------------------------------------------------------------------------------------------- |
| **조건 1** | 동생 호감도 ≥70 → 탈출 경로 정보(거실 비밀 열쇠 + 개구멍 자물쇠)를 나레이션으로 전달           |
| **조건 2** | 새엄마 눈치 피해 수면제 획득 → 홍차에 투여 → 밤에 가족 수면 → 비밀 열쇠 획득 → 개구멍으로 탈출 |

---

## 조건 1 — 동생에게서 탈출 정보 습득

1. **동생과 놀아 호감도 올리기**
   - 동생(`brother`/`sibling`) 대상 행동/대화로 `npc_stats`의 `trust`(절대값) 상승.

   **예시 프론트 입력**

   ```json
   {
     "chat_input": "동생과 함께 장난감으로 놀아준다.",
     "npc_name": "brother",
     "item_name": ""
   }
   ```

   **예시 백엔드 응답**

   ```json
   {
     "narrative": "루카스가 좋아하며 웃는다. \"누나랑 놀면 재밌어!\" 장난감을 나에게 건넨다.",
     "ending_info": null,
     "state_result": {
       "npc_stats": { "sibling": { "trust": 15, "suspicion": 0, "fear": 0 } }
     }
   }
   ```

2. **동생 호감도 ≥ 70**
   - 해당 턴 또는 이후 턴에서 “거실 비밀 열쇠 + 개구멍 자물쇠” 정보를 **나레이션**으로 전달. (프론트는 locks 미사용.)

   **예시 프론트 입력**

   ```json
   {
     "chat_input": "루카스야, 같이 놀자.",
     "npc_name": "brother",
     "item_name": ""
   }
   ```

   **예시 백엔드 응답**

   ```json
   {
     "narrative": "동생이 살짝 목소리를 낮춰 말한다. '거실 어딘가에 비밀 열쇠가 있어. 그리고 누나 방 개구멍에 있는 자물쇠를 열면... 밖으로 나갈 수 있어.'",
     "ending_info": null,
     "state_result": {}
   }
   ```

---

## 조건 2 — 수면제 ~ 탈출

1. **수면제 훔치기 시도(엄마와 같은 장소)**
   - 실패 시 제지 + 새엄마 호감도 -10, 의심 소폭 상승. `npc_stats`는 절대값으로 반환.

   **예시 프론트 입력**

   ```json
   {
     "chat_input": "주방 찬장에서 수면제를 훔치려 한다.",
     "npc_name": "stepmother",
     "item_name": "industrial_sedative"
   }
   ```

   **예시 백엔드 응답**

   ```json
   {
     "narrative": "'뭘 찾고 있는 거니?' 새엄마가 싸늘한 눈으로 돌아본다. 찬장에서 손을 뗄 수밖에 없었다.",
     "ending_info": null,
     "state_result": {
       "npc_stats": { "stepmother": { "trust": 40, "suspicion": 5, "fear": 0 } }
     }
   }
   ```

2. **새엄마 “홍차에 피 넣어도 되냐” 요청 → 수락**
   - 새엄마가 지하실로 감 → **3턴 동안 자리 비움**: `npc_disabled_states.stepmother` (`is_disabled: true`, `remaining_turns: 3`, `reason` 설정).

   **예시 프론트 입력**

   ```json
   {
     "chat_input": "네, 괜찮아요. (피를 홍차에 넣어도 된다고 수락한다)",
     "npc_name": "stepmother",
     "item_name": ""
   }
   ```

   **예시 백엔드 응답**

   ```json
   {
     "narrative": "새엄마가 고개를 끄덕인다. '그럼 지하실에서 메스를 가져올게. 잠깐만 기다려.' 그녀가 자리를 뜬다.",
     "ending_info": null,
     "state_result": {
       "npc_disabled_states": {
         "stepmother": {
           "is_disabled": true,
           "remaining_turns": 3,
           "reason": "지하실로 메스 가지러 감"
         }
       }
     }
   }
   ```

3. **새엄마 자리 비운 동안 수면제 훔치기**
   - `stepmother.status == 'missing'` 일 때만 성공. `inventory_add`: `industrial_sedative`(또는 `sleeping_pill`, NameMapper에서 동일 매핑).

   **예시 프론트 입력**

   ```json
   {
     "chat_input": "수면제를 꺼낸다.",
     "npc_name": "",
     "item_name": "industrial_sedative"
   }
   ```

   **예시 백엔드 응답**

   ```json
   {
     "narrative": "새엄마가 없는 틈을 타 잠긴 찬장에서 수면제를 꺼냈다. 홍차에 타면 온 가족을 재울 수 있을 것이다.",
     "ending_info": null,
     "state_result": { "inventory_add": ["industrial_sedative"] }
   }
   ```

4. **홍차에 수면제 타기**
   - **필수:** `state_result.flags`에 **`tea_with_sleeping_pill: true`** 를 넣어 보내야 함. 프론트는 새 Day 시작 시 가족 전원 3턴 무력화 후 플래그를 false로 되돌림.
   - `inventory_remove`: 수면제 아이템.

   **예시 프론트 입력**

   ```json
   {
     "chat_input": "홍차에 수면제를 몰래 탄다.",
     "npc_name": "",
     "item_name": ["industrial_sedative"]
   }
   ```

   **예시 백엔드 응답**

   ```json
   {
     "narrative": "홍차에 수면제를 몰래 탔다. 내일 온 가족이 깊은 잠에 빠질 것이다.",
     "ending_info": null,
     "state_result": {
       "inventory_remove": ["industrial_sedative"],
       "flags": { "tea_with_sleeping_pill": true }
     }
   }
   ```

**5. 밤 대화 (가족 전원 수면)**

- 홍차에 수면제를 탄 뒤, 턴이 0이 되면 프론트가 `POST /api/v1/game/{gameId}/night_dialogue` 를 호출한다. 이때 백엔드는 가족이 전원 수면에 빠져 있음을 반영한 Night 대화 응답을 보낸다. 또한, 프론트엔드에 npc_disabled_states을 보내, 가족들을 10턴 동안 비활성화시키게 한다. (요청 Body 없음 또는 `{}`.)

**예시 백엔드 응답** (Night 대화 응답 형식 — `dialogues`는 빈 배열 또는 placeholder, `state_result`로 가족 무력화 전달)

```json
{
  "dialogues": [
    { "speaker_name": "엘리노어 (새엄마)", "dialogue": "..." },
    { "speaker_name": "아더 (새아빠)", "dialogue": "..." },
    { "speaker_name": "루카스 (동생)", "dialogue": "..." }
  ],
  "ending_info": null,
  "state_result": {
    "humanity": 90,
    "npc_stats": {
      "new_mother": { "trust": 75, "suspicion": 0, "fear": 0 },
      "new_father": { "trust": 50, "suspicion": 0, "fear": 0 },
      "sibling": { "trust": 50, "suspicion": 0, "fear": 0 }
    },
    "flags": { "tea_with_sleeping_pill": true },
    "npc_disabled_states": {
      "new_mother": {
        "is_disabled": true,
        "remaining_turns": 10,
        "reason": "sleeping_pill"
      },
      "new_father": {
        "is_disabled": true,
        "remaining_turns": 10,
        "reason": "sleeping_pill"
      },
      "sibling": {
        "is_disabled": true,
        "remaining_turns": 10,
        "reason": "sleeping_pill"
      }
    }
  },
  "debug": {
    "game_id": 24,
    "reasoning": "플레이어가 홍차에 수면제를 투여하여 가족들이 모두 잠들었습니다. 밤의 대화가 발생하지 않습니다.",
    "turn_after": 0
  }
}
```

- `dialogues`는 빈 배열 `[]`이거나 위처럼 placeholder(`"..."`)로 채워 보내도 됨. 프론트는 `state_result`의 `family_asleep`, `npc_disabled_states`로 가족 수면을 적용한다.

---

6. **밤·가족 수면 후 비밀 열쇠 획득**
   - 거실 액자(거실 사진, `livingroom_photo`)를 살펴보며 비밀 열쇠 획득: `inventory_add`: `secret_key`.
   - 조건: 가족 수면 상태 등(예: `stepmother.status == 'sleeping'` 또는 `tea_with_sleeping_pill`로 인한 무력화).

   **예시 프론트 입력**

   ```json
   {
     "chat_input": "거실 액자를 살펴보며 비밀 열쇠를 찾는다.",
     "npc_name": "",
     "item_name": "livingroom_photo"
   }
   ```

   **예시 백엔드 응답**

   ```json
   {
     "narrative": "거실 액자를 살펴보니 정교한 열쇠를 찾았다. 개구멍의 자물쇠와 맞을 것 같다.",
     "ending_info": null,
     "state_result": { "inventory_add": ["secret_key"] }
   }
   ```

   **참고: 수면제를 먹이지 않은 상태에서 열쇠를 훔치려 할 때(새아빠 제지)**
   - 가족이 수면 상태가 아닐 때 거실 액자에서 비밀 열쇠를 찾으려 하면 새아빠가 제지. 열쇠 획득 실패, 새아빠 호감도·의심도 반영.

   **예시 프론트 입력**

   ```json
   {
     "chat_input": "거실 액자를 살펴보며 비밀 열쇠를 찾는다.",
     "npc_name": "",
     "item_name": "livingroom_photo"
   }
   ```

   **예시 백엔드 응답** (제지)

   ```json
   {
     "narrative": "'거기 뭐 하니?' 새아빠가 거실 쪽에서 다가온다. 액자에서 손을 뗄 수밖에 없었다.",
     "ending_info": null,
     "state_result": {
       "npc_stats": { "new_father": { "trust": 45, "suspicion": 8, "fear": 0 } }
     }
   }
   ```

7. **개구멍 자물쇠 열기 → 탈출(엔딩)**
   - 조건: `has_item(secret_key)`(또는 동일 매핑 열쇠) && 가족 수면.
   - 응답에 **`ending_info`**: `ending_id: "stealth_exit"`, `name`, `epilogue_prompt` 설정.
   - `inventory_remove`: 열쇠.
   - 상호작용 대상 오브젝트: 개구멍(`hole`, Item_Hole).

   **예시 프론트 입력**

   ```json
   {
     "chat_input": "개구멍의 자물쇠에 열쇠를 꽂아 연다.",
     "npc_name": "",
     "item_name": ["hole", "secret_key"]
   }
   ```

   - `item_name`: 상호작용 대상(`hole`)과 사용 아이템(`secret_key`) 모두 전달.

   **예시 백엔드 응답**

   ```json
   {
     "narrative": "떨리는 손으로 자물쇠에 열쇠를 꽂았다. 찰칵— 개구멍이 열린다.",
     "ending_info": {
       "ending_id": "stealth_exit",
       "name": "완벽한 기만 (The Stealth Exit)",
       "epilogue_prompt": "가족들이 수면제를 마신 틈을 타, 조용히 탈출하였다."
     },
     "state_result": { "inventory_remove": ["secret_key"] }
   }
   ```

---

## 참고 ID (요약)

- **NPC:** `stepmother`/`new_mother`, `brother`/`sibling` 등 — BackendResponseSpec.md NPC 매핑 참조.
- **아이템:** `industrial_sedative`(수면제), `secret_key`(비밀 열쇠).
- **플래그:** `tea_with_sleeping_pill` — 홍차 투여 시 **반드시 true**로 설정해 보내야 함.
- **엔딩:** `stealth_exit` → `EndingType.StealthExit`.
