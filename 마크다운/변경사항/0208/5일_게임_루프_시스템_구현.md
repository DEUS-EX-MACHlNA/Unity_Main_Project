# 5일 게임 루프 시스템 구현 (2026-02-08)

## 개요
현재 턴 관리 시스템을 확장하여 5일간의 게임 루프를 지원하도록 구현했습니다. 일일 턴 제한(10회) 후 '밤'으로 전환하고, 다음 날 시작 시 인간성 감소(-10) 기능을 포함합니다.

## 변경된 스크립트

### 1. [GameStateManager.cs] - Day 관리 시스템 정리 및 개선

#### Day 등록 및 관리
- **날짜 변수 정리**:
  - `currentDay` 필드: 1일차부터 시작 (기본값 1)
  - `MAX_DAY` 상수: 최대 5일차로 제한
  - `CurrentDay` 프로퍼티: 1~5일차 범위 제한 (클램프 포함)
  
- **초기화**:
  - `Awake()`에서 `currentDay = 1`로 명시적 초기화 추가

#### 메서드 추가 및 개선
- **`AdvanceDay()` 메서드 추가**:
  - `AdvanceToNextDay()`의 별칭 메서드
  - 호환성을 위해 추가

- **`AdvanceToNextDay()` 메서드 개선**:
  - `CurrentDay` 프로퍼티를 통해 값 설정 (클램프 포함)
  - 주석에 "밤을 지나면 자동으로 다음 날로 넘어갑니다" 명시
  - 디버그 로그에 최대 일수 정보 추가

- **`GetCurrentDay()` 메서드 수정**:
  - `CurrentDay` 프로퍼티를 반환하도록 변경

- **`GetMaxDay()` 메서드 추가**:
  - 최대 일수를 반환하는 유틸리티 메서드

- **불필요한 메서드 제거**:
  - `IncrementDay()` 메서드 제거 (중복 기능)

#### 코드 구조
```csharp
// 날짜 변수
private int currentDay = 1; // 1일차부터 시작 (기본값 1)
private const int MAX_DAY = 5; // 최대 5일차

/// <summary>
/// 현재 날짜를 반환합니다 (1~5일차).
/// </summary>
public int CurrentDay 
{ 
    get { return currentDay; } 
    private set { currentDay = Mathf.Clamp(value, 1, MAX_DAY); }
}
```

### 2. [TurnManager.cs] - 새 날 시작 메서드 추가

#### 필드 추가
- **`tutorialSceneName` 필드 추가**:
  - Inspector에서 설정 가능한 Tutorial 씬 이름
  - 기본값: "Tutorial"

#### 메서드 추가
- **`StartNewDay()` 메서드 추가**:
  - `GameStateManager.Instance.AdvanceToNextDay()` 호출 (날짜 진행 및 인간성 감소)
  - `ResetTurns()` 호출 (턴수 초기화)
  - Tutorial 씬으로 전환 (SceneFadeManager 사용)

#### 코드 구조
```csharp
[Header("Scene Transition")]
[SerializeField] private SceneFadeManager fadeManager;
[SerializeField] private string nightSceneName = "Night";
[SerializeField] private string tutorialSceneName = "Tutorial"; // 새로 추가
[SerializeField] private float fadeDuration = 1f;

/// <summary>
/// 새로운 날을 시작합니다. 날짜를 진행하고 턴수를 초기화하며 Tutorial 씬으로 전환합니다.
/// </summary>
public void StartNewDay()
{
    // GameStateManager를 통해 다음 날 진행 (인간성 감소 포함)
    GameStateManager.Instance.AdvanceToNextDay();
    
    // 턴수 초기화
    ResetTurns();
    
    // Tutorial 씬으로 전환 (페이드 효과)
    fadeManager.LoadSceneWithFade(tutorialSceneName, fadeDuration);
}
```

### 3. [NightDialogueManager.cs] - 중복 필드 제거

#### 버그 수정
- **중복 필드 제거**:
  - `fadeManager` 필드 중복 제거 (24번 줄만 유지)
  - `[Header("Scene Transition")]` 중복 제거
  - `nextSceneName` 필드 제거 (`tutorialSceneName`만 유지)

#### 기존 동작 유지
- `OnAllDialoguesComplete()`에서 `AdvanceToNextDay()` 호출
- Tutorial 씬으로 전환하는 로직 유지

## 게임 루프 흐름

```
게임 시작 (1일차, 10턴)
  ↓
API 호출 → ConsumeTurn() → 턴 감소 (10 → 9 → ... → 0)
  ↓
턴 0 도달 → Night 씬 전환 (SceneFadeManager 페이드 효과)
  ↓
Night 씬 대화 진행
  ↓
대화 완료 → AdvanceToNextDay() 호출
  ↓
2일차로 진행 (CurrentDay = 2)
  ↓
인간성 10% 감소 (시간 경과 페널티)
  ↓
OnDayChanged 이벤트 발생
  ↓
TurnManager.OnDayChanged() → ResetTurns() → 턴수 10으로 초기화
  ↓
Tutorial 씬 전환 (SceneFadeManager 페이드 효과)
  ↓
(반복, 최대 5일차까지)
```

## 주요 기능

### 1. Day 관리
- **기본값**: 1일차
- **최대값**: 5일차
- **자동 제한**: `CurrentDay` 프로퍼티가 1~5 범위로 클램프

### 2. 밤 이후 다음 날 전환
- Night 씬에서 대화 완료 시 자동으로 다음 날로 진행
- `AdvanceToNextDay()` 호출을 통해:
  - 날짜 증가
  - 인간성 10% 감소
  - `OnDayChanged` 이벤트 발생

### 3. 턴 관리
- 새 날 시작 시 턴수 자동 초기화 (10턴)
- `OnDayChanged` 이벤트를 통해 자동 처리

### 4. 씬 전환
- 턴 0 도달 시: Tutorial → Night 씬
- 밤 대화 완료 시: Night → Tutorial 씬
- 모든 씬 전환에 페이드 효과 적용

## 검증 사항

### 자동 검증
- ✅ Unity 스크립트 컴파일: 오류 0개, 경고 0개
- ✅ 린터 검증: 오류 없음
- ✅ MCP 검증: 정상

### 수동 검증 필요
1. **턴 소모**: API 호출 시 TurnsText가 10 → 9 → ... → 0으로 감소하는지 확인
2. **밤 전환**: 턴 0 시 SceneFadeManager를 통해 "Night" 씬으로 전환되는지 확인
3. **날짜 진행**: 
   - Night 씬에서 대화 완료 후 `AdvanceToNextDay()` 호출 확인
   - `CurrentDay` 증가 확인
   - 인간성 수치 10 감소 확인
   - 턴 수가 10으로 초기화되는지 확인
4. **5일차 종료**: 5일차 종료 시 적절한 처리 확인

## Unity Inspector 설정

### TurnManager 컴포넌트
- **tutorialSceneName**: "Tutorial" (기본값, 필요시 수정)
- **fadeManager**: SceneFadeManager 참조 연결 확인
- **nightSceneName**: "Night" (기본값)
- **fadeDuration**: 1초 (기본값)

## 참고 사항

- `StartNewDay()` 메서드는 선택적으로 사용 가능 (현재는 NightDialogueManager에서 직접 `AdvanceToNextDay()` 호출)
- `CurrentDay` 프로퍼티와 `currentDay` 필드는 모두 유지 (사용자 요청)
- 기존 `AdvanceToNextDay()` 메서드는 유지 (호환성)

