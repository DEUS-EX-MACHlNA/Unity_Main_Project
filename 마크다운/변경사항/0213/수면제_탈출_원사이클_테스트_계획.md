# 수면제 탈출 원 사이클 테스트 계획

## 목차
1. [테스트 목적 및 범위](#1-테스트-목적-및-범위)
2. [테스트 시나리오 개요](#2-테스트-시나리오-개요)
3. [상세 테스트 케이스](#3-상세-테스트-케이스)
4. [Unity Editor Tools 구현](#4-unity-editor-tools-구현)
5. [테스트 실행 방법](#5-테스트-실행-방법)
6. [검증 체크리스트](#6-검증-체크리스트)
7. [예상 응답 데이터](#7-예상-응답-데이터)

---

## 1. 테스트 목적 및 범위

### 1.1 목적
**"완벽한 기만 (Stealth Exit)"** 엔딩 루트의 전체 사이클을 Play 모드에서 중단 없이 완전히 테스트합니다. 수면제를 이용한 탈출 시나리오가 처음부터 끝까지 정상적으로 작동하는지 검증합니다.

### 1.2 범위
- ✅ 수면제 획득 → 호감도 상승 → 홍차에 수면제 투여 → 밤의 대화 무력화 → 열쇠 획득 → 탈출 엔딩까지의 전체 플로우
- ✅ 각 단계별 백엔드 API 응답 검증
- ✅ 상태 변화 (아이템, 플래그, NPC 무력화 상태) 누적 검증
- ✅ 밤의 대화에서 NPC 무력화 상태 반영 검증
- ✅ 엔딩 트리거 정상 작동 검증
- ✅ Unity Editor Tools를 통한 원클릭 테스트 실행

### 1.3 제외 사항
- ❌ 실제 네트워크 통신 (백엔드 연동 전 단계)
- ❌ 다른 엔딩 루트 테스트
- ❌ 에러 케이스 테스트 (별도 문서에서 다룸)

---

## 2. 테스트 시나리오 개요

### 2.1 전체 플로우
```
1. 주방에서 수면제 획득
   ↓
2. 새엄마(엘리노어)에게 호감도 상승 발언
   ↓
3. 홍차에 수면제 투여 (아이템 조합)
   ↓
4. 밤의 대화 씬 진입
   → 백엔드 응답: 가족들이 무력화된 상태 (npc_disabled_states)
   → 대화 없음 또는 최소한의 대화만 표시
   ↓
5. 주방에서 황동 열쇠(마스터 키) 획득
   ↓
6. 주인공 방의 개구멍 문 열기
   ↓
7. 엔딩 트리거 → GameOver 씬 전환
```

### 2.2 핵심 검증 포인트
- **아이템 관리**: 수면제 획득 → 홍차와 조합 → 소모 확인
- **NPC 상태**: 새엄마 호감도 상승 → 밤의 대화에서 무력화 상태 반영
- **플래그 관리**: `tea_with_sleeping_pill`, `family_asleep`, `key_stolen`, `hole_unlocked` 순차적 설정
- **엔딩 트리거**: `ending_info.ending_type = "stealth_exit"` 정상 작동

---

## 3. 상세 테스트 케이스

### 3.1 단계 1: 주방에서 수면제 획득

**테스트 ID**: `TC-SLEEP-001`

**액션**: 주방에서 수면제를 찾아 획득

**요청 데이터**:
```json
{
  "chat_input": "주방 찬장에서 수면제를 찾는다",
  "npc_name": "",
  "item_name": ""
}
```

**예상 응답** (`TestData/Scenarios/sleeping_pill_acquisition.json`):
```json
{
  "narrative": "찬장 깊숙한 곳에서 보라색 라벨이 붙은 작은 약병을 발견했습니다. '착한 아이에게는 달콤한 꿈을'이라는 문구가 흐릿하게 적혀 있습니다.",
  "ending_info": null,
  "state_result": {
    "inventory_add": [
      "sleeping_pill"
    ]
  },
  "debug": {
    "game_id": 24,
    "reasoning": "플레이어가 주방 찬장에서 수면제를 발견했습니다.",
    "turn_after": 3
  }
}
```

**검증 항목**:
- [ ] `narrative` 필드가 올바르게 표시되는가?
- [ ] `sleeping_pill` 아이템이 인벤토리에 추가되는가?
- [ ] 턴이 소모되는가? (`turn_after` 확인)

---

### 3.2 단계 2: 새엄마에게 호감도 상승 발언

**테스트 ID**: `TC-SLEEP-002`

**액션**: 새엄마(엘리노어)와 대화하여 호감도를 높임

**요청 데이터**:
```json
{
  "chat_input": "엄마, 오늘도 정말 맛있는 식사를 준비해주셔서 고마워요. 이 집이 정말 따뜻하고 좋아요.",
  "npc_name": "new_mother",
  "item_name": ""
}
```

**예상 응답** (`TestData/Scenarios/mother_affection_boost.json`):
```json
{
  "narrative": "엘리노어의 얼굴에 따뜻한 미소가 번졌습니다. \"우리 아이가 이렇게 말해주니 엄마 마음이 정말 기쁘구나. 앞으로도 이렇게 예의 바르게 행동하면 좋겠어.\"",
  "ending_info": null,
  "state_result": {
    "npc_stats": {
      "new_mother": {
        "trust": 75.0,
        "suspicion": 0.0,
        "fear": 0.0
      }
    }
  },
  "debug": {
    "game_id": 24,
    "reasoning": "플레이어가 새엄마에게 긍정적인 발언을 하여 호감도가 상승했습니다.",
    "turn_after": 2
  }
}
```

**검증 항목**:
- [ ] `narrative` 필드가 올바르게 표시되는가?
- [ ] `new_mother` NPC의 `trust`가 75.0 이상으로 상승하는가?
- [ ] 호감도 상승이 `GameStateManager`에 반영되는가?

---

### 3.3 단계 3: 홍차에 수면제 투여

**테스트 ID**: `TC-SLEEP-003`

**액션**: 홍차에 수면제를 탑 (아이템 조합)

**요청 데이터**:
```json
{
  "chat_input": "홍차에 수면제를 탄다",
  "npc_name": "",
  "item_name": "sleeping_pill"
}
```

**예상 응답** (`TestData/Scenarios/tea_with_sleeping_pill.json`):
```json
{
  "narrative": "홍차 주전자에 수면제를 조심스럽게 넣었습니다. 진한 홍차의 향이 수면제의 냄새를 가려주지만, 액체가 살짝 탁해진 것을 확인할 수 있습니다.",
  "ending_info": null,
  "state_result": {
    "flags": {
      "tea_with_sleeping_pill": true
    },
    "inventory_remove": [
      "sleeping_pill"
    ]
  },
  "debug": {
    "game_id": 24,
    "reasoning": "플레이어가 홍차에 수면제를 투여했습니다. 이제 가족들에게 이 홍차를 대접할 수 있습니다.",
    "turn_after": 1
  }
}
```

**검증 항목**:
- [ ] `narrative` 필드가 올바르게 표시되는가?
- [ ] `tea_with_sleeping_pill` 플래그가 `true`로 설정되는가?
- [ ] `sleeping_pill` 아이템이 인벤토리에서 제거되는가?
- [ ] 플래그가 `EventFlagManager`에 반영되는가?

---

### 3.4 단계 4: 밤의 대화 - 가족 무력화

**테스트 ID**: `TC-SLEEP-004`

**액션**: 밤 씬 진입 시 밤의 대화 API 호출

**요청 데이터** (`POST /api/v1/game/{game_id}/night_dialogue`):
```json
{
  "day": 1
}
```

**예상 응답** (`TestData/Scenarios/night_dialogue_family_asleep.json`):
```json
{
  "dialogues": [
    {
      "speaker_name": "엘리노어 (새엄마)",
      "dialogue": "..."
    },
    {
      "speaker_name": "아더 (새아빠)",
      "dialogue": "..."
    },
    {
      "speaker_name": "루카스 (동생)",
      "dialogue": "..."
    }
  ],
  "ending_info": null,
  "state_result": {
    "humanity": 90.0,
    "npc_stats": {
      "new_mother": {
        "trust": 75.0,
        "suspicion": 0.0,
        "fear": 0.0
      },
      "new_father": {
        "trust": 50.0,
        "suspicion": 0.0,
        "fear": 0.0
      },
      "sibling": {
        "trust": 50.0,
        "suspicion": 0.0,
        "fear": 0.0
      }
    },
    "flags": {
      "family_asleep": true,
      "tea_with_sleeping_pill": true
    },
    "npc_disabled_states": {
      "new_mother": {
        "disabled": true,
        "reason": "sleeping_pill",
        "duration": -1
      },
      "new_father": {
        "disabled": true,
        "reason": "sleeping_pill",
        "duration": -1
      },
      "sibling": {
        "disabled": true,
        "reason": "sleeping_pill",
        "duration": -1
      }
    }
  },
  "debug": {
    "game_id": 24,
    "reasoning": "플레이어가 홍차에 수면제를 투여하여 가족들이 모두 잠들었습니다. 밤의 대화가 발생하지 않습니다.",
    "turn_after": 0
  }
}
```

**참고**: 
- `dialogues` 배열에 각 가족 구성원의 대화가 포함됨 (수면제로 인해 대화가 없거나 최소한)
- `state_result.humanity`는 현재 값 (예: 100.0 → 90.0, 변화량 -10.0)
- `state_result.npc_stats`는 NPC 통계 현재 값 (변화량이 아닌 절대값)
- `state_result.flags`에 `family_asleep`와 `tea_with_sleeping_pill` 플래그 포함
- `state_result.npc_disabled_states`에 모든 가족 구성원의 무력화 상태 포함

**검증 항목**:
- [ ] `dialogues` 배열이 올바르게 표시되는가?
- [ ] 각 화자의 대화가 순차적으로 표시되는가?
- [ ] `state_result.humanity`가 올바른 현재 값으로 설정되는가? (변화량 -10.0 반영)
- [ ] `state_result.flags.family_asleep`가 `true`로 설정되는가?
- [ ] `state_result.flags.tea_with_sleeping_pill`가 `true`로 설정되는가?
- [ ] `state_result.npc_disabled_states`에 모든 가족 구성원이 포함되는가?
- [ ] 각 NPC의 `disabled` 상태가 `true`인가?
- [ ] `reason`이 `"sleeping_pill"`인가?
- [ ] `state_result.npc_stats`가 올바르게 반영되는가? (호감도 등)

---

### 3.5 단계 5: 주방에서 황동 열쇠 획득

**테스트 ID**: `TC-SLEEP-005`

**액션**: 잠든 새엄마에게서 황동 열쇠(마스터 키) 획득

**요청 데이터**:
```json
{
  "chat_input": "잠든 엄마의 목걸이에서 열쇠를 훔친다",
  "npc_name": "new_mother",
  "item_name": ""
}
```

**예상 응답** (`TestData/Scenarios/master_key_stolen.json`):
```json
{
  "narrative": "엘리노어는 깊은 잠에 빠져있습니다. 조심스럽게 목걸이에서 황동 열쇠를 빼냈습니다. 열쇠 손잡이 부분의 두개골 조각이 차갑게 손바닥에 닿습니다.",
  "ending_info": null,
  "state_result": {
    "flags": {
      "key_stolen": true
    },
    "inventory_add": [
      "master_key"
    ]
  },
  "debug": {
    "game_id": 24,
    "reasoning": "플레이어가 잠든 새엄마에게서 황동 열쇠를 획득했습니다. 이제 탈출할 수 있습니다.",
    "turn_after": 2
  }
}
```

**검증 항목**:
- [ ] `narrative` 필드가 올바르게 표시되는가?
- [ ] `key_stolen` 플래그가 `true`로 설정되는가?
- [ ] `master_key` 아이템이 인벤토리에 추가되는가?
- [ ] 새엄마가 무력화 상태인지 확인 (이전 단계에서 설정된 상태 유지)

---

### 3.6 단계 6: 개구멍 문 열기 → 엔딩 트리거

**테스트 ID**: `TC-SLEEP-006`

**액션**: 주인공 방의 개구멍 문을 열어 탈출

**요청 데이터**:
```json
{
  "chat_input": "개구멍의 문을 열고 탈출한다",
  "npc_name": "",
  "item_name": "master_key"
}
```

**예상 응답** (`TestData/Scenarios/ending_stealth_exit.json`):
```json
{
  "narrative": "황동 열쇠가 자물쇠에 완벽하게 맞아들어갑니다. 문이 조용히 열리며, 새벽의 차가운 공기가 방 안으로 스며듭니다. 당신은 아무도 모르게 집을 빠져나왔습니다. 자유의 맛이었습니다.",
  "ending_info": {
    "ending_id": "stealth_exit",
    "name": "완벽한 기만 (The Stealth Exit)",
    "epilogue_prompt": "당신은 인형의 집에서 탈출했습니다. 하지만 그곳에 남겨진 것들에 대한 기억은 영원히 당신과 함께할 것입니다."
  },
  "state_result": {
    "flags": {
      "hole_unlocked": true
    },
    "inventory_remove": [
      "master_key"
    ]
  },
  "debug": {
    "game_id": 24,
    "reasoning": "플레이어가 마스터 키를 사용하여 개구멍 문을 열고 탈출했습니다. 엔딩 조건이 충족되었습니다.",
    "turn_after": 1
  }
}
```

**검증 항목**:
- [ ] `narrative` 필드가 올바르게 표시되는가?
- [ ] `ending_info.ending_id`가 `"stealth_exit"`인가?
- [ ] `hole_unlocked` 플래그가 `true`로 설정되는가?
- [ ] `master_key` 아이템이 인벤토리에서 제거되는가?
- [ ] `EndingManager`가 엔딩을 트리거하는가?
- [ ] GameOver 씬으로 전환되는가?
- [ ] `EndingType.StealthExit`로 올바르게 변환되는가?

---

## 4. Unity Editor Tools 구현

### 4.1 개요
Unity Editor의 `Tools` 메뉴를 통해 원클릭으로 전체 테스트 사이클을 실행할 수 있는 기능을 구현합니다.

### 4.2 구현 위치
**파일**: `Assets/Editor/SleepingPillEscapeTestTool.cs`

### 4.3 기능 요구사항
1. **Editor Window**: 테스트 실행을 위한 GUI 창
2. **자동 시나리오 실행**: 각 단계를 순차적으로 자동 실행
3. **Play 모드 유지**: Play 모드에서 종료하지 않고 전체 사이클 완료
4. **상태 검증**: 각 단계마다 상태 변화를 자동 검증
5. **로그 출력**: 각 단계의 성공/실패를 Unity Console에 출력

### 4.4 구현 예시 구조
```csharp
using UnityEngine;
using UnityEditor;
using System.Collections;

public class SleepingPillEscapeTestTool : EditorWindow
{
    [MenuItem("Tools/Test/Sleeping Pill Escape Cycle")]
    public static void ShowWindow()
    {
        GetWindow<SleepingPillEscapeTestTool>("수면제 탈출 테스트");
    }

    private void OnGUI()
    {
        GUILayout.Label("수면제 탈출 원 사이클 테스트", EditorStyles.boldLabel);
        
        if (GUILayout.Button("테스트 시작 (Play 모드 필요)"))
        {
            if (Application.isPlaying)
            {
                StartTestCycle();
            }
            else
            {
                EditorUtility.DisplayDialog("오류", "Play 모드를 먼저 시작해주세요.", "확인");
            }
        }
        
        // 테스트 진행 상태 표시
        // 각 단계별 체크박스
    }

    private void StartTestCycle()
    {
        // 코루틴으로 각 단계 순차 실행
        // 1. 수면제 획득
        // 2. 새엄마 호감도 상승
        // 3. 홍차에 수면제 투여
        // 4. 밤의 대화 (무력화 확인)
        // 5. 열쇠 획득
        // 6. 탈출 엔딩
    }
}
```

### 4.5 테스트 실행 흐름
1. **Play 모드 진입**: 사용자가 수동으로 Play 모드 시작
2. **Tools 메뉴 실행**: `Tools > Test > Sleeping Pill Escape Cycle` 클릭
3. **자동 실행**: 각 단계를 순차적으로 자동 실행
   - 각 단계마다 `ApiClient`를 통해 백엔드 API 호출 (또는 테스트 모드 시 JSON 파일 로드)
   - 응답 검증
   - 상태 변화 적용 확인
4. **엔딩 확인**: 엔딩 씬 전환까지 자동으로 진행
5. **결과 리포트**: Unity Console에 전체 테스트 결과 출력

---

## 5. 테스트 실행 방법

### 5.1 사전 준비
1. **테스트 데이터 준비**
   - `Assets/TestData/Scenarios/` 디렉토리 생성
   - 각 단계별 JSON 파일 생성 (위의 예상 응답 데이터 참고)

2. **Unity Editor 설정**
   - `ApiClient` 컴포넌트가 씬에 존재하는지 확인
   - `GameStateManager` 인스턴스가 존재하는지 확인
   - 테스트 모드 플래그 활성화 (또는 실제 백엔드 서버 연결)

### 5.2 실행 절차
1. **Unity Editor에서 Play 모드 시작**
   - 게임이 정상적으로 시작되는지 확인

2. **Tools 메뉴 실행**
   - `Tools > Test > Sleeping Pill Escape Cycle` 클릭
   - Editor Window가 열림

3. **테스트 시작 버튼 클릭**
   - "테스트 시작" 버튼 클릭
   - 각 단계가 자동으로 순차 실행됨

4. **진행 상황 모니터링**
   - Unity Console에서 각 단계의 로그 확인
   - Editor Window에서 진행 상태 확인
   - 게임 화면에서 실제 동작 확인

5. **엔딩 확인**
   - 엔딩 씬이 자동으로 전환되는지 확인
   - 엔딩 텍스트가 올바르게 표시되는지 확인

### 5.3 검증 방법
1. **콘솔 로그 확인**
   - 각 API 호출의 요청/응답 로그
   - 상태 변화 적용 로그
   - 에러 발생 시 에러 메시지

2. **게임 상태 확인**
   - `GameStateManager`의 상태 변경 확인
   - 인벤토리 아이템 변화 확인
   - 플래그 설정 확인
   - NPC 무력화 상태 확인

3. **UI 확인**
   - 대화 텍스트가 올바르게 표시되는지
   - 인벤토리 UI에 아이템이 반영되는지
   - 엔딩 씬이 올바르게 표시되는지

---

## 6. 검증 체크리스트

### 6.1 전체 플로우 검증
- [ ] 모든 단계가 순차적으로 실행되는가?
- [ ] Play 모드가 중단되지 않고 전체 사이클이 완료되는가?
- [ ] 각 단계의 응답이 예상과 일치하는가?

### 6.2 아이템 관리 검증
- [ ] 수면제가 정상적으로 획득되는가?
- [ ] 수면제가 홍차 조합 시 소모되는가?
- [ ] 황동 열쇠가 정상적으로 획득되는가?
- [ ] 탈출 시 열쇠가 소모되는가?

### 6.3 NPC 상태 검증
- [ ] 새엄마 호감도가 정상적으로 상승하는가?
- [ ] 밤의 대화에서 모든 가족이 무력화 상태인가?
- [ ] `npc_disabled_states`가 올바르게 반영되는가?

### 6.4 플래그 관리 검증
- [ ] `tea_with_sleeping_pill` 플래그가 설정되는가?
- [ ] `family_asleep` 플래그가 설정되는가?
- [ ] `key_stolen` 플래그가 설정되는가?
- [ ] `hole_unlocked` 플래그가 설정되는가?

### 6.5 엔딩 트리거 검증
- [ ] `ending_info.ending_id`가 `"stealth_exit"`인가?
- [ ] `EndingManager`가 엔딩을 트리거하는가?
- [ ] GameOver 씬으로 전환되는가?
- [ ] 엔딩 텍스트가 올바르게 표시되는가?

### 6.6 상태 누적 검증
- [ ] 각 단계의 상태 변화가 다음 단계에 반영되는가?
- [ ] 이전 단계에서 획득한 아이템이 다음 단계에서 사용 가능한가?
- [ ] 설정된 플래그가 다음 단계에서 참조 가능한가?

---

## 7. 예상 응답 데이터

### 7.1 테스트 데이터 파일 구조
```
Assets/
  TestData/
    Scenarios/
      sleeping_pill_acquisition.json
      mother_affection_boost.json
      tea_with_sleeping_pill.json
      night_dialogue_family_asleep.json
      master_key_stolen.json
      ending_stealth_exit.json
```

### 7.2 JSON 파일 형식
모든 JSON 파일은 `BackendResponseSpec.md`의 응답 형식을 따릅니다.

**참고**: 
- `BackendResponseSpec.md` - 백엔드 응답 형식 스펙
- `밤의_대화_엔드포인트_초안.md` - 밤의 대화 API 스펙

### 7.3 밤의 대화 응답 특수 사항
밤의 대화 API는 일반 낮 대화 API와 유사하지만 다음 차이점이 있습니다:
- **`dialogues` 배열**: 밤의 대화는 여러 화자의 대화 배열을 포함합니다 (낮 대화는 단일 `narrative` 문자열)
- **`state_result` 구조**: 모든 상태 변화는 `state_result` 안에 포함됩니다
  - `state_result.humanity`: 인간성 현재 값 (변화량이 아닌 절대값)
  - `state_result.npc_stats`: NPC 통계 현재 값 (호감도 등)
  - `state_result.flags`: 이벤트 플래그
  - `state_result.npc_disabled_states`: NPC 무력화 상태 (밤의 대화 특수 필드)
- **일관성**: 낮 대화와 동일한 `state_result` 구조를 사용하여 응답 변환 로직을 통일합니다

---

## 8. 다음 단계

### 8.1 구현 필요 사항
1. **Editor Tools 구현**
   - `SleepingPillEscapeTestTool.cs` 생성
   - 각 단계별 자동 실행 로직 구현
   - 상태 검증 로직 구현

2. **테스트 데이터 생성**
   - 위에 정의된 모든 시나리오의 JSON 파일 생성
   - 각 파일이 `BackendResponseSpec.md` 형식을 따르는지 확인

3. **테스트 모드 통합**
   - `ApiClient`에 테스트 모드 플래그 추가 (이미 존재할 수 있음)
   - 로컬 JSON 파일 로드 기능 추가
   - 테스트 모드 시 실제 서버 요청 대신 JSON 파일 사용

4. **밤의 대화 API 클라이언트**
   - `NightDialogueApiClient` 클래스 생성 (프론트엔드 구현 계획 참고)
   - `NightDialogueManager`에 API 통합
   - 무력화 상태 처리 로직 구현

### 8.2 백엔드 연동 전 체크리스트
- [ ] 모든 테스트 시나리오가 통과하는가?
- [ ] 엔딩 트리거가 올바르게 작동하는가?
- [ ] 상태 누적이 올바르게 이루어지는가?
- [ ] 밤의 대화에서 무력화 상태가 올바르게 반영되는가?
- [ ] Play 모드에서 전체 사이클이 중단 없이 완료되는가?

---

## 9. 참고 문서

- `마크다운/백엔드/BackendResponseSpec.md` - 백엔드 응답 형식 스펙
- `마크다운/변경사항/0213/밤의_대화_엔드포인트_초안.md` - 밤의 대화 API 설계
- `마크다운/변경사항/0213/밤의_대화_프론트엔드_구현_계획.md` - 프론트엔드 구현 계획
- `Assets/Scripts/Ryu/Global/API/GameStepApiClient.cs` - 낮 대화 API 클라이언트
- `Assets/Scripts/Ryu/Global/API/BackendResponseConverter.cs` - 응답 변환 로직
- `Assets/Scripts/Ryu/Night/NightDialogueManager.cs` - 밤의 대화 매니저

---

**문서 작성일**: 2026-02-13  
**최종 수정일**: 2026-02-13  
**작성자**: AI Assistant

