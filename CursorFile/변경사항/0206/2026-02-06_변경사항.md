# 변경사항 기록 - 2026년 2월 6일

**작성일:** 2026-02-06  
**작업자:** AI Assistant

---

## 📋 변경 사항 요약

오늘은 다음 세 가지 주요 작업을 수행했습니다:

1. **새엄마(엘리노어) 스키마 구성** - 백엔드 통신용 데이터 구조 설계
2. **Hover 강조 효과 구현** - ClickableObject 스크립트에 hover 시 하얀색 테두리 표시 기능 추가
3. **Cake 오브젝트에 hover 효과 적용** - Stepmother와 동일한 상호작용 기능 추가

---

## 1. 새엄마(엘리노어) 스키마 구성

### 목적
백엔드 서버와 통신하기 위한 NPC 캐릭터 데이터 스키마를 설계했습니다.

### 설계 내용

#### C# 클래스 스키마
- `StepmotherSchema`: 새엄마 캐릭터의 전체 정보를 담는 메인 클래스
- `SpeechPattern`: 말투 및 대화 패턴 정보
- `CharacterStats`: 호감도, 인간성 등 상태 정보
- `BehaviorPattern`: 호감도에 따른 행동 패턴
- `NightConversation`: 밤의 대화 관련 설정

#### 주요 필드
```csharp
- characterId: "stepmother_eleanor"
- name: "엘리노어"
- role: "집안의 실세, 인형 개조의 집도의, 메인 감시자"
- stats.affection: 0~100 (호감도)
- stats.humanity: -100 (인간화 불가, 최종보스)
- stats.canBeHumanized: false
```

#### API 요청/응답 확장
- `NPCInteractionRequest`: 기존 ChatRequest를 확장하여 NPC 정보 포함
- `NPCInteractionResponse`: NPC 상태 업데이트 및 게임 효과 포함

### 파일 위치
- 스키마 정의는 코드로 제안되었으며, 실제 구현 시 `Assets/scripts/Ryu/Schemas/` 폴더에 생성 예정

---

## 2. Hover 강조 효과 구현

### 목적
게임 기획안에 명시된 "상호작용 가능한 일러스트는 테두리가 흰색으로 굵게 표시(강조)됨" 기능을 구현했습니다.

### 수정된 파일
- `Assets/scripts/Ryu/ClickableObject.cs`

### 주요 변경 사항

#### 추가된 인터페이스
```csharp
IPointerEnterHandler, IPointerExitHandler
```

#### 추가된 필드
- `hoverBorderColor`: Hover 시 테두리 색상 (기본값: 흰색)
- `hoverBorderThickness`: 테두리 두께 (기본값: 5, 5)
- `_outlineComponent`: UI Image용 Outline 컴포넌트
- `_imageComponent`: UI Image 컴포넌트 참조
- `_spriteRenderer`: SpriteRenderer 컴포넌트 참조
- `_isHovering`: 현재 hover 상태 플래그

#### 추가된 메서드
- `SetupOutlineComponent()`: Outline 컴포넌트 자동 설정
- `OnPointerEnter()`: 마우스 hover 시작 시 호출
- `OnPointerExit()`: 마우스 hover 종료 시 호출
- `OnDestroy()`: 오브젝트 파괴 시 hover 상태 정리

### 동작 방식

#### UI Image의 경우
- Unity의 `Outline` 컴포넌트를 자동으로 추가
- Hover 시 `Outline.enabled = true`로 활성화
- 하얀색 테두리 표시

#### SpriteRenderer의 경우
- 색상 변경으로 강조 (밝기 1.2배)
- 향후 더 정교한 Outline 효과 구현 가능

### Inspector 설정
- `Hover Border Color`: 테두리 색상 조정 가능
- `Hover Border Thickness`: 테두리 두께 조정 가능 (X, Y)

---

## 3. Cake 오브젝트에 hover 효과 적용

### 작업 내용
Unity 씬의 Cake 오브젝트에 `ClickableObject` 컴포넌트를 추가하여 hover 강조 효과를 적용했습니다.

### 적용된 오브젝트
- **Cake** (InstanceID: -54496)
  - 컴포넌트: `Transform`, `SpriteRenderer`, `ClickableObject` (신규 추가)

### 기능
- 마우스 hover 시 하얀색 테두리 강조
- 클릭 시 InputField에 "Cake" 블록 자동 추가
- Stepmother와 동일한 상호작용 경험 제공

### 참고사항
- Cake 오브젝트는 `SpriteRenderer`를 사용하므로 hover 감지를 위해 `Collider2D` 컴포넌트가 필요합니다
- StepMother 오브젝트에는 `BoxCollider2D`가 이미 설정되어 있습니다
- 필요시 Cake 오브젝트에도 Collider 추가 가능

---

## 📁 변경된 파일 목록

### 수정된 파일
1. `Assets/scripts/Ryu/ClickableObject.cs`
   - Hover 효과 기능 추가
   - UI Image 및 SpriteRenderer 지원

### 새로 생성된 파일
- 없음 (스키마는 코드로 제안됨)

### Unity 씬 변경사항
- `Tutorial_old 1` 씬의 Cake 오브젝트에 `ClickableObject` 컴포넌트 추가

---

## 🎯 테스트 방법

### Hover 효과 테스트
1. Unity Editor에서 Play 모드 실행
2. Stepmother 또는 Cake 오브젝트에 마우스를 올림
3. 하얀색 테두리가 표시되는지 확인
4. 마우스를 벗어나면 테두리가 사라지는지 확인

### 클릭 기능 테스트
1. Stepmother 또는 Cake 오브젝트 클릭
2. InputField에 해당 오브젝트 이름이 블록으로 추가되는지 확인
3. 예: "@StepMother " 또는 "@Cake "

---

## 🔄 향후 개선 사항

### 스키마 관련
- [ ] 실제 C# 스키마 클래스 파일 생성
- [ ] API 통신 로직에 스키마 통합
- [ ] 다른 NPC 캐릭터(새아빠, 동생) 스키마도 구성

### Hover 효과 관련
- [ ] SpriteRenderer용 더 정교한 Outline 효과 구현
- [ ] 애니메이션 효과 추가 (페이드 인/아웃)
- [ ] 사운드 효과 추가 (hover 시 효과음)

### 상호작용 관련
- [ ] 더 많은 상호작용 가능한 오브젝트 추가
- [ ] 오브젝트별 고유한 hover 효과 설정 가능하도록 확장

---

## 📝 참고 문서

- 게임 기획안: `CursorFile/Guide/시나리오.pdf`
- 이전 작업: `CursorFile/GameObject_클릭_입력_블록_생성_문제_해결.md`

---

## ✅ 완료 체크리스트

- [x] 새엄마 스키마 설계 및 문서화
- [x] ClickableObject에 hover 효과 기능 추가
- [x] Stepmother 오브젝트 hover 효과 테스트
- [x] Cake 오브젝트에 ClickableObject 컴포넌트 추가
- [x] 변경사항 문서화

---

**작업 완료 시간:** 2026-02-06


---

## 4. REST API 연동 및 응답 표시 개선 (ngrok FastAPI)

### 목적
Unity 클라이언트에서 백엔드 서버(FastAPI, ngrok)로 사용자 입력을 전송하고, 응답을 UI에 표시하도록 구현했습니다.

### 주요 구현
- REST 호출: `POST /api/v1/game/{game_id}/step`
- 요청 스키마: `StepRequest` (`chat_input`, `npc_name`, `item_name`)
- 응답 처리: 서버 JSON 응답에서 `event_description`만 추출하여 화면에 표시

### 관련 파일
- `Assets/scripts/Ryu/ApiClient.cs`
  - `StepRequest`, `GameResponse` 추가
  - `ExtractEventDescription()`로 `event_description` 추출 후 `\n`로 합쳐 출력

---

## 5. InputField ↔ ResultText UI 토글 및 입력 UX 개선

### 목적
입력 중에는 결과 텍스트를 숨기고, 결과 출력 중에는 입력창을 재활성화하는 UX를 구현했습니다.

### 주요 구현
- InputField 선택/해제에 따라 `resultText` 활성/비활성 전환
- `resultText` 클릭 시 출력 종료 → InputField 포커스 복귀
- InputField 텍스트 색상을 흰색으로 고정

### 관련 파일
- `Assets/scripts/Ryu/InputHandler.cs`
  - `onSelect`, `onDeselect` 이벤트 연결
  - `EventTrigger`로 `resultText` 클릭 처리
  - `myInputField.textComponent.color = Color.white;`

---

## 6. 월드 오브젝트 클릭 → InputField 블록 삽입 기능

### 목적
StepMother/Cake 같은 월드(SpriteRenderer) 오브젝트를 클릭하면 InputField에 블록 참조 형식(`@이름 `)이 삽입되도록 구현했습니다.

### 핵심 포인트
- `InputHandler.AddBlockToInput()`에서 커서 위치에 `@{blockName} ` 삽입
- 월드 2D 오브젝트 클릭 처리를 위해 `Main Camera`에 `Physics2DRaycaster` 추가
- 클릭 대상 오브젝트에 `BoxCollider2D` 추가

### 관련 파일
- `Assets/scripts/Ryu/InputHandler.cs`
  - `AddBlockToInput(string blockName)` 추가
- `Assets/scripts/Ryu/ClickableObject.cs`
  - `IPointerClickHandler` 기반 클릭 처리
  - (사용자 수정 반영 포함) Hover 효과(Outline/색상 강조) 로직 포함

### 씬 변경
- `Main Camera`: `Physics2DRaycaster` 추가
- `StepMother`: `BoxCollider2D`, `ClickableObject`
- `Cake`: `BoxCollider2D`, `ClickableObject`, `blockName = "Cake"`

---

## 7. Canvas 좌측 상단 HUD (Day/남은 턴수) 추가

### 목적
Canvas 왼쪽 상단에 Day와 남은 턴수를 별도 오브젝트로 표시합니다.

### 구성 (오브젝트 분리)
- `HUD_TopLeft` (컨테이너)
  - `DayText` (TextMeshProUGUI)
  - `TurnsText` (TextMeshProUGUI)

### 표시 예시
- Day: `Day 01`
- 남은 턴수: `남은 턴수 : 10`

### 관련 파일
- `Assets/scripts/Ryu/DayTurnUI.cs` (신규)
  - `dayText`, `turnsText` 참조
  - `SetDay()`, `SetRemainingTurns()`, `Refresh()` 제공

### 씬 변경
- `GameManager`: `DayTurnUI` 컴포넌트 추가 및 HUD 텍스트 연결

---

## 📁 추가 변경된 파일 목록

### 수정된 파일
- `Assets/scripts/Ryu/ApiClient.cs`
- `Assets/scripts/Ryu/InputHandler.cs`
- `Assets/scripts/Ryu/ClickableObject.cs`

### 새로 생성된 파일
- `Assets/scripts/Ryu/DayTurnUI.cs`

---

## 8. API 타임아웃 처리 및 목업 응답 시스템

### 목적
백엔드 서버 응답이 3초 이상 지연될 경우 자동으로 목업(Mock) 응답을 반환하여 사용자 경험을 개선합니다.

### 주요 구현

#### 타임아웃 설정
- **requestTimeout**: 3초 (Inspector에서 조정 가능)
- **useMockOnTimeout**: 타임아웃 시 목업 사용 여부 (기본: true)

#### 일반 메시지 API (`/api/v1/game/{game_id}/step`)
- 3초 이내 응답 없음 → 목업 응답 자동 반환
- 연결 오류 발생 시 → 목업 응답 자동 반환
- 파싱 오류 발생 시 → 목업 응답 자동 반환

#### 밤의 대화 API (`/api/v1/games/{game_id}/nights`)
- 3초 이내 응답 없음 → 목업 밤의 대화 반환
- 연결 오류 발생 시 → 목업 밤의 대화 반환

### 목업 응답 종류

#### 일반 메시지 목업
사용자 입력 키워드에 따라 다양한 응답 생성:
- **"엘리노어", "StepMother", "새엄마"** → 새엄마 관련 응답 (4종)
- **"케이크", "Cake", "먹"** → 케이크 관련 응답 (4종)
- **"방", "집", "둘러"** → 탐색 관련 응답 (4종)
- **"누구", "이름", "나"** → 자아 관련 응답 (4종)
- **기타** → 일반 응답 (7종)

#### 밤의 대화 목업
- 밤 분위기 관련 응답 (6종)
- Day 정보 포함
- 빈 효과 (NPC 변화 없음)

### 로그 메시지
```
[ApiClient] 타임아웃 발생 (3.02초) - 목업 응답 반환
[ApiClient] 목업 응답 생성: 엘리노어가 당신을 빤히 쳐다본다...
[ApiClient] 밤의 대화 타임아웃 발생 (3.01초) - 목업 응답 반환
```

### 관련 파일
- `Assets/scripts/Ryu/Global/ApiClient.cs`
  - `requestTimeout` 필드 추가 (3초)
  - `useMockOnTimeout` 필드 추가
  - `GenerateMockResponse()` 메서드 추가
  - `GenerateMockNightResponse()` 메서드 추가
  - `PostRequest()` 타임아웃 처리 추가
  - `NightConversationRequest()` 타임아웃 처리 추가

### Unity Inspector 설정
**ApiClient 컴포넌트:**
- Request Timeout: 3 (초 단위)
- Use Mock On Timeout: ✓ (체크됨)