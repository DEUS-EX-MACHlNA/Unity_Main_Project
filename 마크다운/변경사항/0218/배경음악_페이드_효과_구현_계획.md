# 배경음악 페이드 인/아웃 효과 구현 계획 (2026-02-18)

## 개요
배경음악 재생 시 부드러운 페이드 인/아웃 효과를 추가하여 음악 전환이나 시작/정지 시 자연스러운 오디오 경험을 제공합니다.

## 구현 목표

### 1. 핵심 기능
- 음악 시작 시 페이드 인 효과 (볼륨 0 → 목표 볼륨)
- 음악 정지 시 페이드 아웃 효과 (현재 볼륨 → 0)
- 음악 전환 시 크로스페이드 효과 (기존 음악 페이드 아웃 + 새 음악 페이드 인)
- 설정 가능한 페이드 지속 시간

### 2. 기술 요구사항
- 코루틴을 사용한 부드러운 볼륨 조절
- 기존 재생 로직과의 호환성 유지
- 페이드 중 재생 요청 처리 (중복 방지)

## 구현 계획

### 1. 페이드 관련 상수 및 변수 추가

**파일**: `Assets/Scripts/Ryu/Global/Managers/AudioManager.cs`

**추가할 변수**:
```csharp
[Header("Fade Settings")]
[SerializeField] private float defaultFadeDuration = 1f;  // 기본 페이드 지속 시간 (초)

private Coroutine currentFadeCoroutine;  // 현재 실행 중인 페이드 코루틴
private bool isFading = false;  // 페이드 진행 중 여부
```

### 2. 페이드 인 코루틴 구현

**메서드**: `FadeInCoroutine(float targetVolume, float duration)`

**기능**:
- 현재 볼륨에서 목표 볼륨까지 부드럽게 증가
- `Time.deltaTime`을 사용한 Lerp 보간
- 코루틴으로 매 프레임 볼륨 조절

**구현 예시**:
```csharp
private IEnumerator FadeInCoroutine(float targetVolume, float duration)
{
    if (audioSource == null) yield break;
    
    float startVolume = audioSource.volume;
    float elapsed = 0f;
    
    while (elapsed < duration)
    {
        elapsed += Time.deltaTime;
        float t = elapsed / duration;
        audioSource.volume = Mathf.Lerp(startVolume, targetVolume, t);
        yield return null;
    }
    
    audioSource.volume = targetVolume;
    isFading = false;
    Debug.Log($"[AudioManager] 페이드 인 완료: 볼륨 {targetVolume}");
}
```

### 3. 페이드 아웃 코루틴 구현

**메서드**: `FadeOutCoroutine(float duration)`

**기능**:
- 현재 볼륨에서 0까지 부드럽게 감소
- 페이드 완료 후 음악 정지

**구현 예시**:
```csharp
private IEnumerator FadeOutCoroutine(float duration)
{
    if (audioSource == null) yield break;
    
    float startVolume = audioSource.volume;
    float elapsed = 0f;
    
    while (elapsed < duration)
    {
        elapsed += Time.deltaTime;
        float t = elapsed / duration;
        audioSource.volume = Mathf.Lerp(startVolume, 0f, t);
        yield return null;
    }
    
    audioSource.volume = 0f;
    audioSource.Stop();
    isFading = false;
    Debug.Log("[AudioManager] 페이드 아웃 완료");
}
```

### 4. 크로스페이드 코루틴 구현 (선택사항)

**메서드**: `CrossFadeCoroutine(AudioClip newClip, float duration)`

**기능**:
- 기존 음악 페이드 아웃과 새 음악 페이드 인을 동시에 진행
- 두 개의 AudioSource를 사용하거나, 볼륨 조절로 구현

**구현 방식**:
- **방식 1**: 단일 AudioSource + 볼륨 조절 (간단)
  - 기존 음악 볼륨을 0으로 페이드 아웃
  - 새 음악을 볼륨 0으로 시작하여 페이드 인
- **방식 2**: 이중 AudioSource (더 부드러움)
  - 두 번째 AudioSource 추가
  - 기존 음악은 첫 번째 AudioSource에서 페이드 아웃
  - 새 음악은 두 번째 AudioSource에서 페이드 인
  - 전환 완료 후 AudioSource 교체

**초기 구현**: 방식 1로 시작 (단순하고 효과적)

### 5. PlayMusicForTimeOfDay 메서드 수정

**기존 메서드**: `PlayMusicForTimeOfDay(TimeOfDay timeOfDay)`

**수정 사항**:
- 페이드 옵션 파라미터 추가: `bool useFade = true`
- 페이드 지속 시간 파라미터 추가: `float fadeDuration = -1` (기본값 사용)
- 페이드 사용 시 코루틴으로 재생

**수정된 시그니처**:
```csharp
public void PlayMusicForTimeOfDay(TimeOfDay timeOfDay, bool useFade = true, float fadeDuration = -1)
```

**로직**:
1. 페이드 중이면 기존 페이드 코루틴 중지
2. `useFade`가 true면 페이드 인으로 재생
3. `useFade`가 false면 즉시 재생 (기존 방식)

### 6. StopMusic 메서드 수정

**기존 메서드**: `StopMusic()`

**수정 사항**:
- 페이드 옵션 파라미터 추가: `bool useFade = true`
- 페이드 지속 시간 파라미터 추가: `float fadeDuration = -1`

**수정된 시그니처**:
```csharp
public void StopMusic(bool useFade = true, float fadeDuration = -1)
```

### 7. 페이드 중 재생 요청 처리

**문제**: 페이드 중에 새로운 재생 요청이 들어올 경우

**해결 방법**:
- 현재 페이드 코루틴을 중지하고 새 페이드 시작
- `isFading` 플래그로 중복 방지
- 코루틴 참조 관리 (`currentFadeCoroutine`)

**구현**:
```csharp
private void StopCurrentFade()
{
    if (currentFadeCoroutine != null)
    {
        StopCoroutine(currentFadeCoroutine);
        currentFadeCoroutine = null;
    }
    isFading = false;
}
```

## 구현 단계

### Phase 1: 기본 페이드 인/아웃
1. 페이드 관련 변수 추가
2. `FadeInCoroutine()` 구현
3. `FadeOutCoroutine()` 구현
4. `PlayMusicForTimeOfDay()`에 페이드 옵션 추가
5. `StopMusic()`에 페이드 옵션 추가

### Phase 2: 크로스페이드 (선택사항)
1. `CrossFadeCoroutine()` 구현
2. 음악 전환 시 크로스페이드 사용
3. 두 AudioSource 방식으로 업그레이드 (필요시)

### Phase 3: 최적화 및 테스트
1. 페이드 중 재생 요청 처리 개선
2. 성능 테스트
3. 다양한 시나리오 테스트

## 사용 시나리오

### 시나리오 1: 게임 시작 시 음악 페이드 인
```csharp
// Start()에서 호출 시
PlayMusicForTimeOfDay(TimeOfDay.Day, useFade: true, fadeDuration: 2f);
```

### 시나리오 2: 시간대 변경 시 크로스페이드
```csharp
// HandleTimeOfDayChanged()에서 호출 시
PlayMusicForTimeOfDay(TimeOfDay.Night, useFade: true, fadeDuration: 1.5f);
```

### 시나리오 3: 씬 전환 시 음악 페이드 아웃
```csharp
// HandleSceneLoaded()에서 Stop 정책일 때
StopMusic(useFade: true, fadeDuration: 1f);
```

### 시나리오 4: 즉시 재생 (페이드 없음)
```csharp
// 긴급한 상황에서 즉시 재생 필요 시
PlayMusicForTimeOfDay(TimeOfDay.Day, useFade: false);
```

## 기술적 세부사항

### 볼륨 계산
- 페이드 중에도 `MusicVolume` 설정값 유지
- 페이드 완료 후 `MusicVolume`으로 복원
- `SetVolume()` 호출 시 페이드 중이면 즉시 반영

### 코루틴 관리
- `StopCoroutine()`으로 기존 페이드 중지 가능
- 씬 전환 시 코루틴 자동 정리 (MonoBehaviour 파괴 시)
- `DontDestroyOnLoad`이므로 씬 전환 시에도 유지

### 성능 고려
- 코루틴은 가벼운 작업 (매 프레임 볼륨 조절만)
- 추가 메모리 사용 최소화
- GC 압력 없음

## 확장 가능성

### 향후 개선 사항
1. **이징 함수**: Linear 외에 EaseIn, EaseOut, EaseInOut 지원
2. **이중 AudioSource**: 더 부드러운 크로스페이드
3. **페이드 커브**: AnimationCurve를 사용한 커스텀 페이드 곡선
4. **페이드 이벤트**: 페이드 시작/완료 시 콜백 이벤트

## 테스트 계획

### 1. 기본 기능 테스트
- [ ] 페이드 인 정상 작동 확인
- [ ] 페이드 아웃 정상 작동 확인
- [ ] 페이드 지속 시간 정확성 확인
- [ ] 볼륨 최종값 정확성 확인

### 2. 시나리오 테스트
- [ ] 게임 시작 시 페이드 인
- [ ] 시간대 변경 시 크로스페이드
- [ ] 씬 전환 시 페이드 아웃
- [ ] 페이드 중 재생 요청 처리

### 3. 예외 상황 테스트
- [ ] 페이드 중 AudioSource 파괴 시 처리
- [ ] 페이드 중 게임 일시정지 시 처리
- [ ] 매우 짧은 페이드 시간 (0.1초) 테스트
- [ ] 매우 긴 페이드 시간 (10초) 테스트

## 참고사항

### SceneFadeManager와의 차이점
- SceneFadeManager: Image의 alpha 값 조절 (시각적)
- AudioManager: AudioSource의 volume 값 조절 (청각적)
- 동일한 코루틴 패턴 사용

### Unity AudioSource 특성
- `volume`은 0.0 ~ 1.0 범위
- `volume = 0`이어도 재생은 계속됨 (정지하지 않음)
- 페이드 아웃 후 `Stop()` 호출 필요

### 사용자 경험
- 페이드 지속 시간: 1~2초가 적절 (너무 짧으면 효과 없음, 너무 길면 답답함)
- 크로스페이드: 음악 전환 시 자연스러움 향상
- 페이드 인: 게임 시작 시 부드러운 시작

