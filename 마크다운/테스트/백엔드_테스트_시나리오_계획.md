# 백엔드 테스트 시나리오 계획

## 목차
1. [테스트 목적 및 범위](#1-테스트-목적-및-범위)
2. [테스트 환경 설정](#2-테스트-환경-설정)
3. [테스트 시나리오 목록](#3-테스트-시나리오-목록)
4. [상세 테스트 케이스](#4-상세-테스트-케이스)
5. [엔딩 트리거 테스트](#5-엔딩-트리거-테스트)
6. [테스트 실행 방법](#6-테스트-실행-방법)
7. [검증 체크리스트](#7-검증-체크리스트)

---

## 1. 테스트 목적 및 범위

### 1.1 목적
백엔드와 실제 통신하기 전에 다양한 게임 시나리오에 대한 응답 형식과 데이터 처리를 검증합니다.

### 1.2 범위
- ✅ 백엔드 응답 JSON 형식 검증
- ✅ 상태 변화 (NPC 호감도, 인간성, 플래그, 아이템) 처리 검증
- ✅ 엔딩 트리거 처리 검증
- ✅ 필드 생략 규칙 검증
- ✅ 데이터 변환 로직 검증

### 1.3 제외 사항
- ❌ 실제 네트워크 통신 (로컬 모킹 사용)
- ❌ 백엔드 서버 성능 테스트
- ❌ 동시성/멀티플레이어 테스트

---

## 2. 테스트 환경 설정

### 2.1 필요한 구성 요소
- Unity Editor (테스트 실행 환경)
- `ApiClient` 컴포넌트
- `GameStateManager` 인스턴스
- 테스트 모드 플래그 (구현 필요)

### 2.2 테스트 모드 활성화 방법
```csharp
// ApiClient.cs에 추가할 설정
[Header("Test Mode")]
[SerializeField] private bool useTestMode = false;
[SerializeField] private string testScenarioName = "";
```

### 2.3 테스트 데이터 위치
- `Assets/TestData/Scenarios/` - 시나리오별 JSON 응답 파일
- 각 파일명: `{시나리오명}.json`

---

## 3. 테스트 시나리오 목록

### 3.1 기본 시나리오
1. **라이터로 불 지르기** (`lighter_fire`)
   - 플래그 설정: `fire_started`
   - 아이템 소모: `silver_lighter`
   - 인간성 감소 (참고: `BackendResponseSpec.md` 예시 기준, 실제 게임 디자인 확인 필요)

2. **동생에게 장난감 주기** (`sibling_toy`)
   - NPC 호감도 증가: `sibling`
   - 아이템 소모: `siblings_toy`

3. **단순 대화 (상태 변화 없음)** (`simple_dialogue`)
   - NPC와의 대화만 발생
   - 상태 변화 최소화

4. **아이템 획득** (`item_acquisition`)
   - 인벤토리 추가 테스트

### 3.2 엔딩 트리거 시나리오
6. **스텔스 엔딩** (`ending_stealth_exit`)
7. **혼돈의 밤 엔딩** (`ending_chaotic_breakout`)
8. **조력자의 희생 엔딩** (`ending_siblings_help`)
9. **영원한 식사 시간 엔딩** (`ending_eternal_dinner`)

---

## 4. 상세 테스트 케이스

### 4.1 시나리오 1: 라이터로 불 지르기

**테스트 ID**: `TC-001`


**요청 데이터**:
```json
{
  "chat_input": "라이터를 이용해 불을 지른다",
  "npc_name": "",
  "item_name": "silver_lighter"
}
```

**예상 응답** (`TestData/Scenarios/lighter_fire.json`):
```json
{
  "narrative": "라이터의 불꽃이 기름에 닿자 순식간에 화재가 발생했습니다. 집안이 연기로 가득 차기 시작합니다.",
  "ending_info": null,
  "state_result": {
    "flags": {
      "fire_started": true
    },
    "inventory_remove": [
      "silver_lighter"
    ],
  },
  "debug": {
    "game_id": 24,
    "turn_after": 7
  }
}
```

**검증 항목**:
- [ ] `narrative` 필드가 올바르게 표시되는가?
- [ ] `fire_started` 플래그가 `true`로 설정되는가?
- [ ] `silver_lighter` 아이템이 인벤토리에서 제거되는가?
- [ ] 인간성이 60.0으로 설정되는가? (변화량 계산 확인) - **참고**: 백엔드 스펙 예시 기준, 실제 게임 밸런스 확인 필요
- [ ] `ending_info`가 `null`인가?

---

### 4.2 시나리오 2: 동생에게 장난감 주기

**테스트 ID**: `TC-002`

**요청 데이터**:
```json
{
  "chat_input": "동생에게 장난감을 준다",
  "npc_name": "sibling",
  "item_name": "siblings_toy"
}
```

**예상 응답** (`TestData/Scenarios/sibling_toy.json`):
```json
{
  "narrative": "동생은 낡은 태엽 로봇을 받아들고 잠시 멍하니 바라봅니다. 그 순간, 그의 눈에 뭔가 반짝이는 것이 보입니다. \"이거... 나한테 있었던 거 맞지?\" 작은 목소리로 물어보는 동생의 목소리에는 잊혀진 기억의 파편이 섞여 있습니다.",
  "ending_info": null,
  "state_result": {
    "npc_stats": {
      "sibling": {
        "trust": 85.0,
        "suspicion": 0.0,
        "fear": 0.0
      }
    },
    "inventory_remove": [
      "siblings_toy"
    ]
  },
  "debug": {
    "game_id": 24,
    "reasoning": "플레이어가 동생에게 장난감을 제공했습니다. 동생의 호감도가 크게 상승하여 85.0이 되었습니다.",
    "turn_after": 5
  }
}
```

**검증 항목**:
- [ ] `narrative` 필드가 올바르게 표시되는가?
- [ ] `sibling` NPC의 `trust`가 85.0으로 설정되는가?
- [ ] `siblings_toy` 아이템이 인벤토리에서 제거되는가?
- [ ] 다른 NPC 상태는 변경되지 않는가?

---

### 4.3 시나리오 3: 단순 대화 (상태 변화 없음)

**테스트 ID**: `TC-003`

**요청 데이터**:
```json
{
  "chat_input": "안녕하세요",
  "npc_name": "new_father",
  "item_name": ""
}
```

**예상 응답** (`TestData/Scenarios/simple_dialogue.json`):
```json
{
  "narrative": "새아빠가 무표정하게 당신을 바라봅니다.",
  "ending_info": null,
  "state_result": {
    "npc_stats": {
      "new_father": {
        "trust": 51.0
      }
    }
  }
}
```

**검증 항목**:
- [ ] `narrative` 필드가 올바르게 표시되는가?
- [ ] 최소한의 상태 변화만 발생하는가?
- [ ] 불필요한 필드가 생략되는가? (`inventory_add/remove`, `flags` 등)

---

### 4.4 시나리오 4: 아이템 획득

**테스트 ID**: `TC-004`

**요청 데이터**:
```json
{
  "chat_input": "지하실에서 사진을 찾는다",
  "npc_name": "",
  "item_name": ""
}
```

**예상 응답** (`TestData/Scenarios/item_acquisition.json`):
```json
{
  "narrative": "먼지로 뒤덮인 오래된 사진을 발견했습니다. 사진 속의 가족은 당신이 기억하는 것과는 다릅니다.",
  "ending_info": null,
  "state_result": {
    "inventory_add": [
      "real_family_photo"
    ]
  }
}
```

**검증 항목**:
- [ ] `narrative` 필드가 올바르게 표시되는가?
- [ ] `real_family_photo` 아이템이 인벤토리에 추가되는가?
- [ ] 아이템 개수가 기본값 1로 설정되는가?

---

## 5. 엔딩 트리거 테스트

### 5.1 스텔스 엔딩 (Stealth Exit)

**테스트 ID**: `TC-006`

**요청 데이터**:
```json
{
  "chat_input": "조용히 집을 빠져나간다",
  "npc_name": "",
  "item_name": ""
}
```

**예상 응답** (`TestData/Scenarios/ending_stealth_exit.json`):
```json
{
  "narrative": "당신은 아무도 모르게 집을 빠져나왔습니다. 새벽의 차가운 공기가 당신의 얼굴을 스칩니다. 자유의 맛이었습니다.",
  "ending_info": {
    "ending_type": "stealth_exit",
    "description": "완벽한 기만 엔딩"
  },
  "state_result": {
    "flags": {
      "hole_unlocked": true
    }
  }
}
```

**검증 항목**:
- [ ] `ending_info.ending_type`이 `"stealth_exit"`인가?
- [ ] `EndingManager`가 엔딩을 트리거하는가?
- [ ] GameOver 씬으로 전환되는가?
- [ ] `EndingType.StealthExit`로 올바르게 변환되는가?

---

### 5.2 혼돈의 밤 엔딩 (Chaotic Breakout)

**테스트 ID**: `TC-007`

**예상 응답** (`TestData/Scenarios/ending_chaotic_breakout.json`):
```json
{
  "narrative": "불길이 집 전체를 삼켰습니다. 당신은 혼란 속에서 탈출했지만, 그 대가는 컸습니다.",
  "ending_info": {
    "ending_type": "chaotic_breakout",
    "description": "혼돈의 밤 엔딩"
  },
  "state_result": {
    "flags": {
      "fire_started": true
    }
  }
}
```

**검증 항목**:
- [ ] `ending_type`이 `"chaotic_breakout"`인가?
- [ ] `EndingType.ChaoticBreakout`로 올바르게 변환되는가?

---

### 5.3 조력자의 희생 엔딩 (Siblings Help)

**테스트 ID**: `TC-008`

**예상 응답** (`TestData/Scenarios/ending_siblings_help.json`):
```json
{
  "narrative": "동생이 당신을 도와줬지만, 그 대가를 치렀습니다. 당신은 탈출했지만 동생은...",
  "ending_info": {
    "ending_type": "siblings_help",
    "description": "조력자의 희생 엔딩"
  },
  "state_result": {}
}
```

**검증 항목**:
- [ ] `ending_type`이 `"siblings_help"`인가?
- [ ] `EndingType.SiblingsHelp`로 올바르게 변환되는가?

---

### 5.4 영원한 식사 시간 엔딩 (Eternal Dinner)

**테스트 ID**: `TC-009`

**예상 응답** (`TestData/Scenarios/ending_eternal_dinner.json`):
```json
{
  "narrative": "당신은 영원히 식탁에 앉아있게 되었습니다. 시간은 멈추고, 모든 것이 반복됩니다.",
  "ending_info": {
    "ending_type": "eternal_dinner",
    "description": "영원한 식사 시간 엔딩"
  }
}
```

**검증 항목**:
- [ ] `ending_type`이 `"eternal_dinner"`인가?
- [ ] `EndingType.EternalDinner`로 올바르게 변환되는가?

---

### 5.5 인간성 0% 엔딩 (Unfinished Doll) - 클라이언트 폴백

**테스트 ID**: `TC-010`

**참고**: 이 엔딩은 클라이언트에서 인간성 0% 도달 시 자동으로 트리거됩니다. 백엔드에서도 트리거할 수 있지만, 클라이언트 폴백이 우선됩니다.

**예상 응답** (`TestData/Scenarios/ending_unfinished_doll.json`):
```json
{
  "narrative": "당신의 인간성이 완전히 사라졌습니다. 당신은 더 이상 인간이 아닙니다.",
  "ending_info": {
    "ending_type": "unfinished_doll",
    "description": "불완전한 박제 엔딩"
  },
  "state_result": {
    "humanity": 0.0
  }
}
```

**검증 항목**:
- [ ] 인간성이 0.0으로 설정되는가?
- [ ] 클라이언트에서 자동으로 엔딩이 트리거되는가? (백엔드 응답과 무관)

---

## 6. 테스트 실행 방법

### 6.1 테스트 모드 활성화

1. Unity Editor에서 `ApiClient` 컴포넌트가 있는 GameObject 선택
2. Inspector에서 `Use Test Mode` 체크
3. `Test Scenario Name`에 테스트할 시나리오 이름 입력 (예: `lighter_fire`)

### 6.2 테스트 실행

1. Play 모드 진입
2. 게임 내에서 해당 액션 수행
3. Unity Console에서 로그 확인:
   - `[GameStepApiClient] POST ...` - 요청 로그
   - `[GameStepApiClient] ========== 백엔드 원본 응답 ==========` - 응답 로그
   - `[BackendResponseConverter]` - 변환 로그

### 6.3 검증 방법

1. **콘솔 로그 확인**
   - 백엔드 응답이 올바르게 파싱되는지 확인
   - 변환된 데이터가 올바른지 확인

2. **게임 상태 확인**
   - `GameStateManager`의 상태 변경 확인
   - NPC 호감도, 인간성, 플래그, 아이템 변화 확인

3. **UI 확인**
   - 대화 텍스트가 올바르게 표시되는지 확인
   - 인벤토리 변화가 UI에 반영되는지 확인

4. **엔딩 트리거 확인**
   - `EndingManager`가 엔딩을 트리거하는지 확인
   - 씬 전환이 올바르게 발생하는지 확인

---

## 7. 검증 체크리스트

### 7.1 기본 기능 검증
- [ ] 모든 시나리오의 JSON 응답이 올바르게 파싱되는가?
- [ ] `narrative` 필드가 게임에 표시되는가?
- [ ] `state_result`의 각 필드가 올바르게 적용되는가?

### 7.2 데이터 변환 검증
- [ ] NPC 이름 매핑이 올바른가? (`sibling` → `NPCType.Sibling`)
- [ ] 아이템 이름 매핑이 올바른가? (`silver_lighter` → `ItemType.SilverLighter`)
- [ ] 엔딩 타입 매핑이 올바른가? (`stealth_exit` → `EndingType.StealthExit`)
- [ ] 플래그 이름 매핑이 올바른가? (`fire_started` → `EventFlags.fireStarted`)

### 7.3 상태 변화 검증
- [ ] NPC 호감도 변화가 올바르게 적용되는가?
- [ ] 인간성 변화량이 올바르게 계산되는가? (현재 값 → 새 값)
- [ ] 플래그 설정/해제가 올바르게 적용되는가?
- [ ] 아이템 추가/제거가 올바르게 적용되는가?
- [ ] NPC 무력화 상태가 올바르게 적용되는가?
- [ ] 잠금 상태가 올바르게 적용되는가?

### 7.4 엔딩 트리거 검증
- [ ] 각 엔딩 타입이 올바르게 트리거되는가?
- [ ] 엔딩 씬 전환이 올바르게 발생하는가?
- [ ] `EndingType` enum 변환이 올바른가?

### 7.5 필드 생략 규칙 검증
- [ ] 변경되지 않은 필드가 생략되어도 정상 동작하는가?
- [ ] 빈 배열/객체가 생략되어도 정상 동작하는가?
- [ ] 선택적 필드(`ending_info`, `debug`)가 없어도 정상 동작하는가?

---

## 8. 테스트 데이터 파일 구조

### 8.1 디렉토리 구조
```
Assets/
  TestData/
    Scenarios/
      lighter_fire.json
      sibling_toy.json
      simple_dialogue.json
      item_acquisition.json
      ending_stealth_exit.json
      ending_chaotic_breakout.json
      ending_siblings_help.json
      ending_eternal_dinner.json
      ending_unfinished_doll.json
```

### 8.2 JSON 파일 형식
모든 JSON 파일은 `BackendResponseSpec.md`의 응답 형식을 따릅니다.

---

## 9. 다음 단계

### 9.1 구현 필요 사항
1. **테스트 모드 구현**
   - `ApiClient`에 테스트 모드 플래그 추가
   - 로컬 JSON 파일 로드 기능 추가
   - 테스트 모드 시 실제 서버 요청 대신 JSON 파일 사용

2. **테스트 데이터 생성**
   - 위에 정의된 모든 시나리오의 JSON 파일 생성
   - 각 파일이 `BackendResponseSpec.md` 형식을 따르는지 확인

3. **테스트 스크립트 작성** (선택적)
   - Unity Editor에서 테스트를 실행할 수 있는 스크립트
   - 자동화된 검증 로직

### 9.2 백엔드 연동 전 체크리스트
- [ ] 모든 테스트 시나리오가 통과하는가?
- [ ] 엔딩 트리거가 올바르게 작동하는가?
- [ ] 데이터 변환이 올바르게 이루어지는가?
- [ ] 필드 생략 규칙이 올바르게 적용되는가?

---

## 10. 참고 문서

- `마크다운/백엔드/BackendResponseSpec.md` - 백엔드 응답 형식 스펙
- `마크다운/백엔드/Backend_Handoff_Notes.md` - 백엔드 전달사항
- `Assets/Scripts/Ryu/Global/API/GameStepApiClient.cs` - API 클라이언트 구현
- `Assets/Scripts/Ryu/Global/API/BackendResponseConverter.cs` - 응답 변환 로직

---

**문서 작성일**: 2025-01-XX  
**최종 수정일**: 2025-01-XX  
**작성자**: AI Assistant

