# 배경음악 시스템 구현 계획 (2026-02-18)

## 개요
게임 플레이 중 시간대(Day/Night)에 따라 자동으로 전환되는 배경음악 시스템을 구현합니다. 씬별 조건부 음악 재생 정책과 설정 메뉴 연동 가능한 볼륨 관리 기능을 포함합니다.

## 구현 목표

### 1. 핵심 기능
- 시간대(Day/Night)별 배경음악 자동 전환
- 씬별 조건부 음악 재생 정책
- 설정 메뉴 연동 가능한 볼륨 관리
- 확장 가능한 구조

### 2. 기술 요구사항
- 싱글톤 패턴으로 전역 관리
- `DontDestroyOnLoad`로 씬 전환 시 음악 유지
- `GameStateManager`와 이벤트 기반 연동
- `PlayerPrefs`를 통한 볼륨 설정 저장

## 구현 계획

### 1. AudioManager 스크립트 생성

**파일 위치**: `Assets/Scripts/Ryu/Global/Managers/AudioManager.cs`

**주요 기능**:
- 싱글톤 패턴 구현 (`DontDestroyOnLoad`)
- `AudioSource` 컴포넌트 관리
- 시간대별 음악 데이터 구조 (`BackgroundMusicData`)
- `GameStateManager.OnTimeOfDayChanged` 이벤트 구독
- 볼륨 관리 (PlayerPrefs 저장/로드)
- 씬별 음악 정책 설정 (Dictionary 기반)

**주요 메서드**:
- `PlayMusicForTimeOfDay(TimeOfDay timeOfDay)`: 시간대에 맞는 음악 재생
- `SetVolume(float volume)`: 볼륨 설정 및 저장
- `StopMusic()`: 음악 정지
- `InitializeMusicData()`: 음악 데이터 초기화
- `HandleTimeOfDayChanged(TimeOfDay timeOfDay)`: 시간대 변경 이벤트 핸들러
- `HandleSceneLoaded(Scene scene, LoadSceneMode mode)`: 씬 로드 이벤트 핸들러

**코드 구조**:
```csharp
using System;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.SceneManagement;

[System.Serializable]
public class BackgroundMusicData
{
    public TimeOfDay timeOfDay;
    public AudioClip musicClip;
    public bool loop = true;
}

public enum MusicPolicy
{
    TimeBased,      // 시간대별 자동 전환
    Fixed,          // 고정 음악
    Stop            // 음악 정지
}

public class AudioManager : MonoBehaviour
{
    public static AudioManager Instance { get; private set; }
    
    [Header("Background Music Settings")]
    [SerializeField] private BackgroundMusicData[] musicData;
    [SerializeField] private float defaultVolume = 0.7f;
    
    private AudioSource audioSource;
    private Dictionary<string, MusicPolicy> sceneMusicPolicies;
    private const string VOLUME_PREFS_KEY = "BackgroundMusicVolume";
    
    // 싱글톤 초기화 및 이벤트 구독
    // 시간대별 음악 재생 로직
    // 볼륨 관리 로직
    // 씬별 정책 처리 로직
}
```

### 2. 오디오 폴더 구조 생성

**폴더 위치**: `Assets/Audio/Music/`

**목적**: 배경음악 파일 저장용 폴더 생성 (오디오 파일은 나중에 수동 추가)

**Unity MCP 작업**: `manage_asset`로 폴더 생성

### 3. AudioManager GameObject 생성 및 설정

**씬**: `PlayersRoom` (현재 활성 씬)

**작업 내용**:
- `AudioManager` GameObject 생성
- `AudioSource` 컴포넌트 추가
- `AudioManager` 스크립트 컴포넌트 추가
- Inspector에서 음악 클립 할당 가능하도록 SerializeField 설정

**Unity MCP 작업**:
- `manage_gameobject`로 GameObject 생성
- `manage_components`로 AudioSource 및 AudioManager 컴포넌트 추가

### 4. GameStateManager 연동

**파일**: `Assets/Scripts/Ryu/Global/Managers/GameStateManager.cs`

**연동 방식**:
- `AudioManager`에서 직접 `GameStateManager.Instance.OnTimeOfDayChanged` 이벤트 구독
- `AudioManager.Awake()` 또는 `Start()`에서 이벤트 구독
- 시간대 변경 시 자동으로 음악 전환

**이벤트 구독 코드**:
```csharp
private void Start()
{
    // GameStateManager가 이미 초기화되었는지 확인
    if (GameStateManager.Instance != null)
    {
        GameStateManager.Instance.OnTimeOfDayChanged += HandleTimeOfDayChanged;
        
        // 현재 시간대에 맞는 음악 재생
        TimeOfDay currentTime = GameStateManager.Instance.GetCurrentTimeOfDay();
        PlayMusicForTimeOfDay(currentTime);
    }
    else
    {
        // GameStateManager가 아직 초기화되지 않은 경우
        // StartCoroutine으로 대기하거나 OnEnable에서 처리
    }
}
```

### 5. 씬별 음악 정책 설정

**정책 정의**:
- **게임플레이 씬**: 시간대별 자동 전환 (`MusicPolicy.TimeBased`)
- **메뉴/타이틀 씬**: 고정 음악 또는 음악 정지 (`MusicPolicy.Fixed` 또는 `MusicPolicy.Stop`)
- **게임오버 씬**: 별도 음악 (`MusicPolicy.Fixed`)

**구현 방식**:
- `SceneManager.sceneLoaded` 이벤트 구독
- 씬 이름 기반으로 정책 Dictionary에서 조회
- 정책에 따라 음악 재생/정지/전환

**정책 초기화 코드**:
```csharp
private void InitializeScenePolicies()
{
    sceneMusicPolicies = new Dictionary<string, MusicPolicy>
    {
        { "PlayersRoom", MusicPolicy.TimeBased },
        { "Hallway", MusicPolicy.TimeBased },
        { "LivingRoom", MusicPolicy.TimeBased },
        { "Kitchen", MusicPolicy.TimeBased },
        { "SiblingsRoom", MusicPolicy.TimeBased },
        { "Basement", MusicPolicy.TimeBased },
        { "Backyard", MusicPolicy.TimeBased },
        { "Title", MusicPolicy.Stop },
        { "GameOver", MusicPolicy.Fixed }
    };
}
```

### 6. 볼륨 설정 시스템

**구현 내용**:
- `PlayerPrefs` 키: `"BackgroundMusicVolume"`
- 기본 볼륨: 0.7f
- `SetVolume(float volume)` 메서드로 실시간 변경 가능
- UI 옵션 메뉴에서 호출 가능한 구조

**볼륨 관리 코드**:
```csharp
public void SetVolume(float volume)
{
    volume = Mathf.Clamp01(volume);
    MusicVolume = volume;
    
    if (audioSource != null)
    {
        audioSource.volume = volume;
    }
    
    PlayerPrefs.SetFloat(VOLUME_PREFS_KEY, volume);
    PlayerPrefs.Save();
}

private void LoadVolume()
{
    MusicVolume = PlayerPrefs.GetFloat(VOLUME_PREFS_KEY, defaultVolume);
    if (audioSource != null)
    {
        audioSource.volume = MusicVolume;
    }
}
```

## 기술적 세부사항

### TimeOfDay 연동
현재 `TimeOfDay` enum은 `Day`와 `Night`만 존재. 초기 구현은 이 두 가지에 대응:
- `Day` → 낮 배경음악
- `Night` → 밤 배경음악

나중에 "밤 대화" 등 추가 시간대가 필요하면 확장 가능.

### 이벤트 구독 시점
`GameStateManager`는 `Awake()`에서 초기화되므로, `AudioManager`는 `Start()`에서 이벤트를 구독하는 것이 안전합니다. 또는 `OnEnable()`에서 구독하고 `OnDisable()`에서 해제하는 방식도 가능합니다.

### 씬 전환 처리
`SceneManager.sceneLoaded` 이벤트를 구독하여 씬별 정책을 적용합니다. 씬 전환 시:
1. 새 씬의 정책 확인
2. 정책에 따라 음악 재생/정지/전환
3. `TimeBased` 정책인 경우 현재 시간대에 맞는 음악 재생

## Unity MCP 작업 순서

1. `create_script`로 `AudioManager.cs` 생성
2. `manage_asset`로 `Assets/Audio/Music/` 폴더 생성
3. `manage_gameobject`로 AudioManager GameObject 생성
4. `manage_components`로 AudioSource 및 AudioManager 컴포넌트 추가
5. `read_console`로 컴파일 에러 확인
6. `refresh_unity`로 Unity 새로고침

## 확장 가능성

### 단기 확장 기능
- 페이드 인/아웃 기능 추가
- 크로스페이드 전환 (음악 간 부드러운 전환)
- 여러 음악 트랙 관리 (같은 시간대에 여러 음악 중 랜덤 선택)

### 장기 확장 기능
- 효과음 시스템 통합
- AudioMixer 연동 (고급 오디오 제어)
- 동적 음악 시스템 (게임 상태에 따른 음악 변화)
- 3D 공간 오디오 지원

## 테스트 계획

### 1. 기본 기능 테스트
- [ ] AudioManager 싱글톤 정상 작동 확인
- [ ] 시간대 변경 시 음악 자동 전환 확인
- [ ] 씬 전환 시 음악 정책 적용 확인
- [ ] 볼륨 설정 저장/로드 확인

### 2. 통합 테스트
- [ ] GameStateManager와 정상 연동 확인
- [ ] 여러 씬 전환 시 음악 정책 정상 작동 확인
- [ ] 게임 재시작 시 볼륨 설정 유지 확인

### 3. 예외 상황 테스트
- [ ] GameStateManager가 없을 때 처리
- [ ] 오디오 파일이 없을 때 처리
- [ ] 씬 정책이 정의되지 않았을 때 기본 동작 확인

## 참고사항

### 오디오 파일 준비
- 배경음악 파일은 `.ogg` 또는 `.mp3` 형식 권장
- Unity에서 압축 설정 확인 (메모리 최적화)
- 파일 크기 고려 (빌드 크기 영향)

### 성능 고려사항
- `DontDestroyOnLoad` 사용 시 메모리 관리 주의
- 오디오 파일은 압축 포맷 사용
- 불필요한 오디오 파일 로드 방지

### 사용자 경험
- 음악 전환 시 부드러운 페이드 효과 (향후 추가)
- 볼륨 조절 시 즉시 반영
- 설정 메뉴에서 쉽게 접근 가능

