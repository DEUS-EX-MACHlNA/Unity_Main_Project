# 동적 상태 관리 정책 (Dynamic State Management Policy)

## 개요
게임 내에서 동적으로 변하는 모든 상태 값들을 백엔드와 프론트엔드 간의 책임 범위에 따라 분류하고, 각 상태의 관리 방식을 정의합니다.

## 목차
1. [백엔드에서 관리하는 상태](#1-백엔드에서-관리하는-상태)
2. [프론트엔드에서 관리하는 상태](#2-프론트엔드에서-관리하는-상태)
3. [하이브리드 관리 상태 (선택 가능)](#3-하이브리드-관리-상태-선택-가능)
4. [상태 동기화 전략](#4-상태-동기화-전략)
5. [결정 가이드라인](#5-결정-가이드라인)

---

## 1. 백엔드에서 관리하는 상태

이 상태들은 **LLM이 플레이어의 자유 서술 입력을 분석**하여 결정하므로 백엔드에서 관리합니다.

### 1.1 플레이어 상태

| 상태 | 설명 | 백엔드 필드명 | 범위/형식 | 비고 |
|------|------|---------------|-----------|------|
| **인간성 변화량** | 플레이어의 인간성 변화 | `humanity_change` | `float` (양수/음수) | ✅ 이미 구현됨 |

### 1.2 NPC 상태

| 상태 | 설명 | 백엔드 필드명 | 범위/형식 | 비고 |
|------|------|---------------|-----------|------|
| **NPC 호감도 변화량** | 각 NPC의 호감도 변화 | `npc_affection_changes` | `NPCAffectionChanges` 구조체 | Phase2 |
| - 새엄마 호감도 | 엘리노어 호감도 변화 | `new_mother` | `float` | Phase2 |
| - 새아빠 호감도 | 아더 호감도 변화 | `new_father` | `float` | Phase2 |
| - 동생 호감도 | 루카스 호감도 변화 | `sibling` | `float` | Phase2 |
| - 강아지 호감도 | 바론 호감도 변화 | `dog` | `float` | Phase2 |
| - 할머니 호감도 | 마가렛 호감도 변화 | `grandmother` | `float` | Phase2 |
| **NPC 인간성 변화량** | 각 NPC의 인간성 변화 | `npc_humanity_changes` | `NPCHumanityChanges` 구조체 | Phase2 |
| - 새아빠 인간성 | 아더 인간성 변화 | `new_father` | `float` | Phase2 (새엄마 제외) |
| - 동생 인간성 | 루카스 인간성 변화 | `sibling` | `float` | Phase2 |
| - 강아지 인간성 | 바론 인간성 변화 | `dog` | `float` | Phase2 |
| - 할머니 인간성 | 마가렛 인간성 변화 | `grandmother` | `float` | Phase2 |

**참고:**
- 새엄마(엘리노어)의 인간성은 변경 불가 (최종보스)
- 모든 변화량은 **상대값(변화량)**으로 제공됨

#### 1.2.1 NPC 무력화 상태

| 상태 | 설명 | 백엔드 필드명 | 범위/형식 | 비고 |
|------|------|---------------|-----------|------|
| **NPC 무력화 상태** | 수면제 등으로 무력화된 NPC | `npc_disabled_states` | `NPCDisabledStates` 구조체 | Phase2 |
| - NPC 무력화 여부 | 각 NPC의 무력화 상태 | `is_disabled` | `bool` | Phase2 |
| - 무력화 남은 턴 수 | 무력화 지속 시간 | `remaining_turns` | `int` | Phase2 |
| - 무력화 이유 | 무력화 원인 | `reason` | `string` | Phase2 |

**백엔드 판정 예시:**
- "수면제를 탄다", "모두에게 차를 권한다" → 가족 무력화 판정
- "새아빠의 찻잔에 수면제를 탄다" → 새아빠만 무력화 판정
- LLM이 상황을 분석하여 어떤 NPC가 무력화되는지, 얼마나 지속되는지 판정

**참고:**
- 무력화 남은 턴 수는 백엔드에서 제공하지만, 프론트엔드에서 턴 소모 시 자동 감소
- 백엔드에서 무력화 상태를 제공하지 않으면 프론트엔드에서 자동으로 처리하지 않음

### 1.3 아이템 상태

| 상태 | 설명 | 백엔드 필드명 | 범위/형식 | 비고 |
|------|------|---------------|-----------|------|
| **아이템 획득** | 플레이어가 아이템을 획득한 경우 | `item_changes.acquired_items` | `ItemAcquisition[]` | Phase3 |
| **아이템 사용/소모** | 플레이어가 아이템을 사용한 경우 | `item_changes.consumed_items` | `ItemConsumption[]` | Phase3 |
| **아이템 상태 변경** | 아이템의 상태 변경 (InWorld → InInventory → Used 등) | `item_changes.state_changes` | `ItemStateChange[]` | Phase3 |

**백엔드 판정 예시:**
- "찬장을 연다", "수면제를 찾는다" → 수면제 획득 판정 (`acquired_items`)
- "홍차에 수면제를 탄다", "케이크를 먹는다" → 수면제 사용 판정 (`consumed_items`)
- "라이터를 이용해 불을 지른다" → 라이터 사용 + 화재 이벤트 플래그 설정
- "라이터를 습득한다" → 라이터 획득 판정

**인벤토리 UI 아이템 사용:**
- 인벤토리에서 아이템 클릭 → `@케이크` 같은 블록 처리
- 사용자가 자연어 입력: `"@케이크를 먹는다"`
- LLM이 현재 월드 정보를 기반으로 동적 변화 판정
- 백엔드에서 아이템 사용 여부, NPC 반응, 이벤트 플래그 등을 종합 판정

**클릭 가능 오브젝트 클릭:**
- 월드의 아이템 오브젝트 클릭 → `@아이템명` 블록 처리
- 사용자가 자연어 입력: `"@수면제를 찾는다"`, `"@수면제를 습득한다"`
- LLM이 현재 상황을 분석하여 획득 여부 판정
- 백엔드에서 아이템 획득 여부, 스토리 일관성, 복잡한 조건 판정 (예: "이미 가지고 있어서 획득 불가")

**참고:**
- LLM이 자연어 입력을 분석하여 아이템 획득/사용/상태 변경을 종합적으로 판정
- 인벤토리 UI 아이템 사용과 클릭 가능 오브젝트 클릭 모두 자연어 입력을 통해 LLM이 판정하므로 백엔드에서 관리
- 아이템 상태 변경은 획득/사용과 함께 자동으로 처리되거나, 별도로 명시 가능
- 아이템 리스폰은 프론트엔드에서 날짜 변경 시 자동 처리 (백엔드 판정 불필요)

### 1.4 엔딩 트리거

| 상태 | 설명 | 백엔드 필드명 | 범위/형식 | 비고 |
|------|------|---------------|-----------|------|
| **엔딩 트리거** | 엔딩 조건 충족 시 트리거 | `ending_trigger` | `string` (엔딩 이름) | Phase4 |

**엔딩 이름 매핑:**
- `"stealth_exit"` → `EndingType.StealthExit`
- `"chaotic_breakout"` → `EndingType.ChaoticBreakout`
- `"siblings_help"` → `EndingType.SiblingsHelp`
- `"unfinished_doll"` → `EndingType.UnfinishedDoll`
- `"eternal_dinner"` → `EndingType.EternalDinner`
- `null` 또는 `"none"` → 엔딩 트리거 없음

### 1.5 이벤트 플래그 (EventFlags)

| 상태 | 설명 | 백엔드 필드명 | 범위/형식 | 비고 |
|------|------|---------------|-----------|------|
| **이벤트 플래그** | 게임 이벤트 상태 | `event_flags` | `EventFlags` 구조체 | Phase4 |
| - 할머니 협력 상태 | `grandmotherCooperation` | `grandmother_cooperation` | `bool` | Phase4 |
| - 개구멍 개방 상태 | `holeUnlocked` | `hole_unlocked` | `bool` | Phase4 |
| - 화재 발생 상태 | `fireStarted` | `fire_started` | `bool` | Phase4 |
| - 가족 수면 상태 | `familyAsleep` | `family_asleep` | `bool` | Phase4 |
| - 열쇠 탈취 상태 | `keyStolen` | `key_stolen` | `bool` | Phase4 |
| - 새아빠에게 발각 | `caughtByFather` | `caught_by_father` | `bool` | Phase4 |
| - 새엄마에게 발각 | `caughtByMother` | `caught_by_mother` | `bool` | Phase4 |
| - 감금된 날짜 | `imprisonmentDay` | `imprisonment_day` | `int` (-1이면 감금 아님) | Phase4 |
| - 커스텀 이벤트 | `customEvents` | `custom_events` | `Dictionary<string, bool>` | Phase4 |

**백엔드 판정 예시:**
- "라이터를 이용해 불을 지른다" → `fire_started: true` 설정
- "모두에게 차를 권한다" → `family_asleep: true` 설정 (수면제 사용 시)
- "새엄마의 목걸이에서 열쇠를 빼낸다" → `key_stolen: true` 설정
- "할머니에게 협력을 요청한다" → `grandmother_cooperation: true` 설정
- LLM이 플레이어의 행동을 분석하여 이벤트 플래그 설정

**참고:**
- LLM이 플레이어의 자연어 입력을 분석하여 이벤트 플래그를 동적으로 설정
- 스토리 일관성과 복잡한 조건 판정을 LLM이 처리

### 1.6 NPC 위치

| 상태 | 설명 | 백엔드 필드명 | 범위/형식 | 비고 |
|------|------|---------------|-----------|------|
| **NPC 위치** | 각 NPC의 현재 위치 | `npc_locations` | `NPCLocations` 구조체 | Phase2 |
| - 새엄마 위치 | 엘리노어 위치 | `new_mother` | `string` (위치 이름) | Phase2 |
| - 새아빠 위치 | 아더 위치 | `new_father` | `string` | Phase2 |
| - 동생 위치 | 루카스 위치 | `sibling` | `string` | Phase2 |
| - 강아지 위치 | 바론 위치 | `dog` | `string` | Phase2 |
| - 할머니 위치 | 마가렛 위치 | `grandmother` | `string` | Phase2 |

**백엔드 판정 예시:**
- "거실로 이동한다" → NPC 위치 업데이트 판정
- "주방에서 새엄마를 만났다" → 새엄마 위치를 주방으로 설정
- LLM이 플레이어의 행동과 스토리 맥락을 분석하여 NPC 위치 업데이트

**참고:**
- LLM이 플레이어의 자연어 입력과 스토리 맥락을 분석하여 NPC 위치를 동적으로 설정
- **백엔드 응답이 항상 우선**: 백엔드에서 NPC 위치를 제공하면 프론트엔드의 씬 전환 업데이트보다 우선 적용
- 백엔드에서 NPC 위치를 제공하지 않으면 이전 상태를 유지하거나 프론트엔드에서 기본값 사용

---

## 2. 프론트엔드에서 관리하는 상태

이 상태들은 **게임 시스템의 메커니즘**에 따라 자동으로 변경되거나, **명확한 사용자 상호작용**에 따라 변경되므로 프론트엔드에서 관리합니다.

### 2.1 시간 및 턴 시스템

| 상태 | 설명 | 관리 방식 | 비고 |
|------|------|-----------|------|
| **현재 시간대** | Day / Night | 턴 소진 시 자동 변경 | Phase4 |
| **현재 턴 수** | 하루 중 사용한 턴 수 | 사용자 입력 시 증가 | Phase4 |
| **현재 날짜** | 1일차 ~ 5일차 | 턴 소진 시 자동 증가 | 기존 구현 |

**변경 로직:**
- 사용자가 입력을 보낼 때마다 `ConsumeTurn()` 호출
- 턴이 소진되면 `TimeOfDay.Night`로 변경
- 날짜 변경 시 턴 수 리셋 및 `TimeOfDay.Day`로 변경

### 2.2 위치 시스템

| 상태 | 설명 | 관리 방식 | 비고 |
|------|------|-----------|------|
| **플레이어 현재 위치** | 현재 씬/위치 | 씬 전환 시 변경 | Phase4 |

**변경 로직:**
- 씬 전환 시 `SetCurrentLocation()` 호출

**참고:**
- NPC 위치는 백엔드에서 관리 (1.6 섹션 참고)
- 플레이어 현재 위치는 프론트엔드에서 씬 전환 시 자동으로 관리

### 2.3 프론트엔드 자동 처리 상태

이 상태들은 백엔드에서 판정하지만, 프론트엔드에서 **게임 시스템 메커니즘**에 따라 자동으로 업데이트됩니다.

| 상태 | 설명 | 관리 방식 | 비고 |
|------|------|-----------|------|
| **NPC 무력화 남은 턴 수 감소** | 무력화 지속 시간 자동 감소 | 턴 소모 시 자동 감소 | Phase2 |
| **아이템 리스폰** | 매일 리스폰되는 아이템 | 날짜 변경 시 자동 처리 | Phase3 |

**변경 로직:**
- 턴 소모 시: `UpdateNPCDisabledStates()` 호출하여 무력화 남은 턴 수 자동 감소
- 날짜 변경 시: `RespawnDailyItems()` 호출

**참고:**
- 백엔드에서 무력화 상태를 제공하면 프론트엔드에서 적용
- 무력화 남은 턴 수는 백엔드에서 제공하지만, 프론트엔드에서 턴 소모 시 자동 감소
- 아이템 리스폰은 백엔드 판정 불필요 (게임 시스템 메커니즘)

---

## 3. 하이브리드 관리 상태 (선택 가능)

현재 모든 주요 상태는 백엔드 또는 프론트엔드에서 명확히 관리하도록 결정되었습니다.

**이미 결정된 상태:**
- 이벤트 플래그: 백엔드에서 관리 (1.5 섹션 참고)
- NPC 위치: 백엔드에서 관리 (1.6 섹션 참고)
- NPC 무력화 상태: 백엔드에서 관리 (1.2.1 섹션 참고)
- 아이템 상태 관리: 백엔드에서 관리 (1.3 섹션 참고)
- 클릭 가능 오브젝트: 백엔드에서 관리 (1.3 섹션 참고)

**향후 추가 고려사항:**
- 새로운 상태가 추가될 경우, 이 섹션에서 하이브리드 관리 여부를 검토할 수 있습니다.

---

## 4. 상태 동기화 전략

### 4.1 백엔드 응답 구조 (현재 계획)

```json
{
  "response": "응답 텍스트",
  "humanity_change": 0.0,
  "npc_affection_changes": {
    "new_mother": 0.0,
    "new_father": 0.0,
    "sibling": 0.0,
    "dog": 0.0,
    "grandmother": 0.0
  },
  "npc_humanity_changes": {
    "new_father": 0.0,
    "sibling": 0.0,
    "dog": 0.0,
    "grandmother": 0.0
  },
  "npc_disabled_states": {
    "new_father": {
      "is_disabled": true,
      "remaining_turns": 3,
      "reason": "수면제"
    }
  },
  "item_changes": {
    "acquired_items": [
      {
        "item_name": "sleeping_pill",
        "count": 1
      }
    ],
    "consumed_items": [
      {
        "item_name": "sleeping_pill",
        "count": 1
      }
    ],
    "state_changes": [
      {
        "item_name": "sleeping_pill",
        "new_state": "used"
      }
    ]
  },
  "event_flags": {
    "grandmother_cooperation": false,
    "hole_unlocked": false,
    "fire_started": true,
    "family_asleep": false,
    "key_stolen": false,
    "caught_by_father": false,
    "caught_by_mother": false,
    "imprisonment_day": -1,
    "custom_events": {}
  },
  "npc_locations": {
    "new_mother": "kitchen",
    "new_father": "living_room",
    "sibling": "siblings_room",
    "dog": "backyard",
    "grandmother": "basement"
  },
  "ending_trigger": null
}
```

**구조체 정의:**
- 모든 필드는 **선택적(optional)**이며, 백엔드에서 제공하지 않을 수 있음
- `npc_disabled_states`: NPC별 무력화 상태 (선택적)
- `item_changes.state_changes`: 아이템 상태 변경 (선택적)
- `event_flags`: 이벤트 플래그 (선택적)
- `npc_locations`: NPC 위치 (선택적)

**백엔드 응답이 없을 때의 처리:**
- 백엔드에서 필드를 제공하지 않으면 **이전 상태를 유지**
- 초기 상태이거나 이전 상태가 없으면 **프론트엔드에서 기본값 사용**
- 예: `npc_locations`가 없으면 이전 NPC 위치 유지, 초기 상태면 기본 위치 사용

### 4.3 프론트엔드 상태 업데이트 순서

1. **백엔드 응답 수신** (`InputHandler.OnApiSuccess`)
2. **플레이어 인간성 변경** (`ModifyHumanity`)
3. **NPC 변화량 적용** (`ModifyAffection`, `ModifyNPCHumanity`)
4. **NPC 무력화 상태 적용** (`SetNPCDisabled` - 백엔드에서 제공 시만, 없으면 이전 상태 유지)
5. **NPC 위치 업데이트** (`SetNPCLocation` - 백엔드에서 제공 시만, **백엔드 응답이 항상 우선**, 없으면 이전 상태 유지)
6. **아이템 변화량 적용** (`AddItem`, `RemoveItem`)
7. **아이템 상태 변경 적용** (`SetItemState` - 백엔드에서 제공 시만, 없으면 이전 상태 유지)
8. **이벤트 플래그 업데이트** (`SetEventFlag` - 백엔드에서 제공 시만, 없으면 이전 상태 유지)
9. **엔딩 트리거 처리** (`TriggerEnding` - 백엔드에서 제공 시만)
10. **턴 소모** (`ConsumeTurn`)
11. **프론트엔드 상태 자동 업데이트**
    - 턴 소진 시 시간대 변경 (`TimeOfDay.Night`)
    - 턴 소모 시 NPC 무력화 남은 턴 수 자동 감소 (`UpdateNPCDisabledStates`)
    - 날짜 변경 시 아이템 리스폰 (`RespawnDailyItems`)

**폴백 전략:**
- 백엔드에서 필드를 제공하지 않으면 **이전 상태를 유지**
- 초기 상태이거나 이전 상태가 없으면 **프론트엔드에서 기본값 사용**
- 모든 백엔드 응답 필드는 선택적(optional)이며, null 체크 필요

---

## 5. 결정 가이드라인

### 5.1 백엔드에서 관리해야 하는 경우

✅ **다음 조건을 만족하면 백엔드에서 관리:**
- LLM이 플레이어의 **자유 서술 입력을 분석**하여 판정해야 하는 경우
- **스토리 일관성**이 중요한 경우
- **복잡한 조건 판정**이 필요한 경우
- **동적 스토리 생성**이 필요한 경우

**예시:**
- NPC 호감도 변화 (플레이어의 대화 내용에 따라)
- NPC 무력화 상태 (플레이어가 "수면제를 탄다"고 서술한 경우)
- NPC 위치 (플레이어가 "거실로 이동한다"고 서술한 경우)
- 아이템 획득/사용/상태 변경 (플레이어의 행동 서술에 따라)
- 인벤토리 UI 아이템 사용 (`@케이크를 먹는다` 같은 자연어 입력)
- 클릭 가능 오브젝트 클릭 (`@수면제를 찾는다` 같은 자연어 입력)
- 이벤트 플래그 (플레이어가 "라이터로 불을 지른다"고 서술한 경우)
- 엔딩 트리거 (복잡한 조건 충족 여부 판정)

### 5.2 프론트엔드에서 관리해야 하는 경우

✅ **다음 조건을 만족하면 프론트엔드에서 관리:**
- **게임 시스템 메커니즘**에 따라 자동으로 변경되는 경우
- **명확한 사용자 상호작용**에 따라 변경되는 경우 (단, 자연어 입력을 받지 않는 경우만)
- **성능이 중요한** 경우 (즉시 반응 필요)
- **로컬 상태 추적**이 필요한 경우

**주의:**
- 클릭이나 UI 버튼이라도, 자연어 입력을 받아 LLM이 판정한다면 백엔드에서 관리해야 함
- 예: 인벤토리 UI 아이템 클릭 → `@아이템명` 블록 처리 → 자연어 입력 → LLM 판정 (백엔드 관리)

**예시:**
- 턴 수, 시간대 (게임 시스템)
- 씬 전환 시 위치 변경 (명확한 상호작용)
- 턴 소모 시 NPC 무력화 남은 턴 수 자동 감소 (게임 시스템)
- 날짜 변경 시 아이템 리스폰 (게임 시스템)


### 5.4 권장 결정 체크리스트

각 하이브리드 상태에 대해 다음 질문에 답하세요:

- [ ] **LLM이 판정해야 하나?** → Yes면 백엔드
- [ ] **게임 시스템 메커니즘인가?** → Yes면 프론트엔드
- [ ] **명확한 상호작용인가?** → Yes면 프론트엔드 (단, 자연어 입력을 받지 않는 경우만)
- [ ] **스토리 일관성이 중요한가?** → Yes면 백엔드
- [ ] **즉시 반응이 필요한가?** → Yes면 프론트엔드
- [ ] **복잡한 조건 판정이 필요한가?** → Yes면 백엔드

---

## 6. 현재 구현 상태 요약

### 6.1 백엔드에서 관리 (구현 완료/예정)

| 상태 | Phase | 구현 상태 |
|------|-------|----------|
| 플레이어 인간성 변화량 | - | ✅ 구현 완료 |
| NPC 호감도 변화량 | Phase2 | 📋 계획 완료 |
| NPC 인간성 변화량 | Phase2 | 📋 계획 완료 |
| NPC 무력화 상태 | Phase2 | 📋 계획 완료 (백엔드 판정) |
| NPC 위치 | Phase2 | 📋 계획 완료 (백엔드 판정) |
| 아이템 획득/사용 | Phase3 | 📋 계획 완료 |
| 아이템 상태 변경 | Phase3 | 📋 계획 완료 (백엔드 판정) |
| 인벤토리 UI 아이템 사용 | Phase3 | 📋 계획 완료 (백엔드 판정) |
| 클릭 가능 오브젝트 클릭 | Phase3 | 📋 계획 완료 (백엔드 판정) |
| 이벤트 플래그 | Phase4 | 📋 계획 완료 (백엔드 판정) |
| 엔딩 트리거 | Phase4 | 📋 계획 완료 |

### 6.2 프론트엔드에서 관리 (구현 완료/예정)

| 상태 | Phase | 구현 상태 |
|------|-------|----------|
| 시간대 및 턴 시스템 | Phase4 | 📋 계획 완료 |
| 플레이어 현재 위치 | Phase4 | 📋 계획 완료 |
| NPC 무력화 남은 턴 수 자동 감소 | Phase2 | 📋 계획 완료 (프론트엔드 자동 처리) |
| 아이템 리스폰 | Phase3 | 📋 계획 완료 (프론트엔드 자동 처리) |
| 날짜 시스템 | - | ✅ 구현 완료 |

### 6.3 결정 필요 (하이브리드)

현재 모든 주요 상태는 백엔드 또는 프론트엔드에서 명확히 관리하도록 결정되었습니다.

---

## 7. 다음 단계

1. **백엔드 응답 구조 확장**
   - `GameResponse` 구조체에 `npc_disabled_states` 필드 추가 (Phase2)
   - `GameResponse` 구조체에 `npc_locations` 필드 추가 (Phase2)
   - `GameResponse` 구조체에 `item_changes.state_changes` 필드 추가 (Phase3)
   - `GameResponse` 구조체에 `event_flags` 필드 추가 (Phase4)

2. **프론트엔드 구현**
   - Phase2: NPC 무력화 상태 및 NPC 위치 백엔드 응답 처리 로직 추가
   - Phase3: 아이템 상태 변경 백엔드 응답 처리 로직 추가
   - Phase4: 이벤트 플래그 백엔드 응답 처리 로직 추가
   - 상태 동기화 로직 구현

3. **백엔드 구현**
   - LLM이 자연어 입력을 분석하여 이벤트 플래그 판정 로직 구현
   - LLM이 자연어 입력을 분석하여 NPC 위치 업데이트 판정 로직 구현

---

## 참고 문서

- [Phase1: 데이터 모델 정의](Phase1_데이터_모델_정의.md)
- [Phase2: NPC 시스템 구현](Phase2_NPC_시스템_구현.md)
- [Phase3: 아이템 시스템 구현](Phase3_아이템_시스템_구현.md)
- [Phase4: 엔딩 시스템 구현](Phase4_엔딩_시스템_구현.md)

